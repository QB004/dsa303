# Data loading, cleaning and transformation

## Loading the data

```{r}
# Loading libraries to work with spatial data
library(tidyverse); library(sf); library(tmap); library(aspace); library(spdep); library(corrplot); library(readxl)

# Loading Singapore URA subzone boundary data
sg_ura_boundaries <- 
  st_read("MasterPlan2014SubzoneBoundaryWebSHP/MP14_SUBZONE_WEB_PL.shp") %>% 
  st_make_valid()

# Saving CRS provided by SG boundary map
sg_crs <- st_crs(sg_ura_boundaries)

# Loading cleaned obesity data from HPB and giving spatial awareness
obesity_data <- 
  # "#N/A" values converted to "NA" for R to be able to read it
  read.csv("obesity.csv", na.strings = "#N/A") %>% 
  select(-PT_ID.1) %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  st_transform(crs = sg_crs) %>% 
  st_make_valid()

# Loading cleaned HMSP data from HPB and giving spatial awareness
hmsp_data_sf <- 
  read.csv("hmsp_tier_pri_sec.csv") %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  st_transform(crs = sg_crs) %>% 
  st_make_valid() 

# Checking that all CRS are matching
isTRUE(all.equal(st_crs(sg_ura_boundaries), st_crs(obesity_data), st_crs(hmsp_data_sf)))

# Checking CRS units
st_crs(sg_ura_boundaries)$units
st_crs(obesity_data)$units
st_crs(hmsp_data_sf)$units
```

## Joining with relevant datasets

```{r}
# Loading General Information of Schools dataset
schools_info <- 
  read_excel("Generalinformationofschools.xlsx", na = c("na", "NA")) %>% 
  select(school_name, dgp_code:mothertongue3_code)

obesity_data <- obesity_data %>% 
  left_join(schools_info, by = join_by(SCHOOL == school_name))
```

## Transforming data to be usable for analysis

```{r}
# Changing "PRIMARY + SECONDARY" level label to match PRI and SEC classification
obesity_data <- obesity_data %>% mutate(
  LEVEL = case_when(
    LEVEL == "PRIMARY + SECONDARY" & PRI == 1 ~ "PRIMARY",
    LEVEL == "PRIMARY + SECONDARY" & PRI == 0 ~ "SECONDARY",
    TRUE ~ LEVEL
    )
  )

obesity_data_sf <- obesity_data %>% 
  pivot_longer(
    # pivot_longer to separate obesity data columns into a tidy format
    cols = starts_with("X"),
    names_to = c("YEAR", "CATEGORY"),
    names_prefix = "X",
    names_sep = "_",
    names_transform = list(YEAR = as.integer),
    values_to = "COUNT"
    ) %>% 
  mutate(
    # Transform obesity count and school enrollment into an obesity prevalence figure
    PREVALENCE = COUNT / ENROLMENT
    )
```

We filter our data for the most recent year as the enrollment data given is for 2024. We focus on the number of students categorised as Overweight or Severely Overweight (OSO), in the most recent year 2023.

We remove "FUCHUN SECONDARY SCHOOL" as the enrollment data may be inaccurate due to school mergers. For our analysis for 2023, we remove "TANGLIN SECONDARY SCHOOL" and "GUANGYANG PRIMARY SCHOOL" as these schools have merged and no longer have overweight counts. We remove all remaining schools with no recorded data in 2023 (only "TANJONG KATONG GIRLS' SCHOOL")

```{r}
# for now, filter for 2023 data and overweight and severely overweight
obesity_data_sf_2023_OSO <- obesity_data_sf %>% 
  filter(
    YEAR == 2023, CATEGORY == "OSO", 
    !(SCHOOL %in% 
        c("FUCHUN SECONDARY SCHOOL", "TANGLIN SECONDARY SCHOOL","GUANGYANG PRIMARY SCHOOL")
      ),
    !is.na(PREVALENCE)
    )

#Combining prof's data with ours (delete this line pls)
oso23 = read_csv("Prof's Codes/oso23.csv", show_col_types = FALSE)
oso23 = oso23 |> drop_na(OSO_pct) 

# Re-classify
oso23[,c(3, 4, 8, 13:26)] = lapply(oso23[,c(3, 4, 8, 13:26)], as.factor)
oso23_new = oso23 %>% select(c("PT_ID", "HMSP_Tier", "HMSP_Score", "special"))
obesity_data_sf_2023_OSO_new = left_join(obesity_data_sf_2023_OSO, oso23_new, by = "PT_ID")
obesity_data_sf_2023_OSO = obesity_data_sf_2023_OSO_new #we can delete this line if necessary and just use obesity_data_sf_2023_oso_new
```

# Exploratory data analysis (by Prof)

```{r}
tmap_mode("plot")
tm_shape(sg_ura_boundaries) + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.4, fill = "TIER", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "HMSP Tiers"))

tm_shape(sg_ura_boundaries) + tm_fill() + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.4, fill = "ZONE", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "School zones"))

tm_shape(sg_ura_boundaries) + tm_fill() + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.3, fill = "CLUSTER", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "School clusters")) +
  tm_facets_wrap(by = "ZONE")

# OSO rate by school level
ggplot(obesity_data_sf_2023_OSO, aes(x = LEVEL, y = PREVALENCE, fill = LEVEL)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by School Level",
       x = "Level",
       y = "Prevalence Rate") +
  theme_minimal() +
  coord_flip()  # Flip the coordinates to make it horizontal 

# OSO rate by Zone
ggplot(obesity_data_sf_2023_OSO, aes(x = ZONE, y = PREVALENCE, fill = ZONE)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by Zone",
       x = "Zone",
       y = "Prevalence Rate") +
  theme_minimal() +
  coord_flip()  # Flip the coordinates to make it horizontal 

# OSO rate by School Type
sub = obesity_data_sf_2023_OSO |>
  filter(type_code %in% c("GOVERNMENT SCHOOL", "GOVERNMENT-AIDED SCH"))
ggplot(sub, aes(x = type_code, y = PREVALENCE, fill = type_code)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by School Type",
       x = "School Type",
       y = "Prevalence Rate") +
  theme_minimal() +
  coord_flip()  # Flip the coordinates to make it horizontal 

# OSO rate by Gender Mix
ggplot(obesity_data_sf_2023_OSO, aes(x = nature_code, y = PREVALENCE, fill = nature_code)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by Gender Mix",
       x = "Gender Mix",
       y = "Prevalence Rate") +
  theme_minimal() +
  scale_x_discrete(drop = TRUE) +
  coord_flip() # Flip the coordinates to make it horizontal 
  
# OSO rate by Specialised Programs
ggplot(obesity_data_sf_2023_OSO, aes(x = special, y = PREVALENCE, fill = special)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by Specialised Programs",
       x = "Special Program",
       y = "Prevalence Rate") +
  theme_minimal() +
  scale_x_discrete(drop = TRUE) +
  coord_flip() # Flip the coordinates to make it horizontal 

# OSO rate by HMSP Tier
ggplot(obesity_data_sf_2023_OSO, aes(x = HMSP_Tier, y = PREVALENCE, fill = HMSP_Tier)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of OSO23 rate by HMSP Tier",
       x = "HMSP Tier",
       y = "OSO Rate") +
  theme_minimal() +
  scale_x_discrete(drop = TRUE) +
  coord_flip() # Flip the coordinates to make it horizontal 

cor(obesity_data_sf_2023_OSO$PREVALENCE, obesity_data_sf_2023_OSO$HMSP_Score)

```

```{r}

```


# Singapore maps

These are maps that define Singapore's regions based on URA defined boundaries (region, planning area, subzone) and MOE defined boundaries (zone, cluster). Subsequently, the defined regions can be used together with aggregated data so that we can examine overweight prevalence and other contributing factors by these differently delimited regions.

```{r}
tmap_mode("view")

# URA regions map
ura_regions <- sg_ura_boundaries %>% group_by(REGION_N) %>% 
  summarise(geometry = st_union(geometry))
ura_regions_map <- tm_shape(ura_regions, name = "URA regions") + tm_polygons(
    col = "grey", fill = "REGION_N", fill_alpha = 0.25, 
    fill.legend = tm_legend(title = "URA regions"))

# URA planning areas map
ura_planning_areas <- sg_ura_boundaries %>% group_by(PLN_AREA_N) %>% 
  summarise(geometry = st_union(geometry))
ura_planning_areas_map <- tm_shape(ura_planning_areas, name = "URA planning areas") + 
  tm_polygons(
    col = "grey", fill = "PLN_AREA_N", fill_alpha = 0.25, 
    fill.legend = tm_legend_hide())

# URA subzones map
ura_subzones <- sg_ura_boundaries %>% group_by(SUBZONE_N) %>% 
  summarise(geometry = st_union(geometry))
ura_subzones_map <- tm_shape(ura_subzones, name = "URA subzones") + tm_polygons(
  col = "grey", fill = "SUBZONE_N", fill_alpha = 0.25, 
  fill.legend = tm_legend_hide())

# MOE zones map
moe_zones <- obesity_data %>% group_by(ZONE) %>% 
  summarise(geometry = st_union(geometry)) %>% st_convex_hull()
moe_zone_map <- tm_shape(moe_zones, name = "MOE zones") + tm_polygons(
  col = "grey", fill = "ZONE", fill_alpha = 0.25, 
  fill.legend = tm_legend(title = "MOE School Zones"))

# MOE clusters map
moe_clusters <- obesity_data %>% group_by(CLUSTER) %>% 
  summarise(geometry = st_union(geometry)) %>% st_convex_hull()
moe_cluster_map <- tm_shape(moe_clusters, name = "MOE clusters") + tm_polygons(
  col = "grey", fill = "CLUSTER", fill_alpha = 0.25, 
  fill.legend = tm_legend_hide())
```

# Obesity profile in Singapore (Colin)

## Obesity prevalence overview map

The following map is an overview of overweight prevalence in Singapore schools. You may use the different layers provided in the map to view the individual school data against URA regions, planning areas and subzones, or MOE zones and clusters. Note that MOE zones and clusters have overlapping areas.

```{r}
tmap_mode("view")

# School obesity map plot
school_obesity_map <- tm_shape(obesity_data_sf_2023_OSO, name = "Overweight prevalence") +
  tm_symbols(
    size = 0.5,
    shape = "LEVEL",
    shape.legend = tm_legend(
      position = c("BOTTOM", "CENTER"),
      title = "Educational level"
      ),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

# Overview of overweight prevalence levels in Singapore schools
ura_regions_map + ura_planning_areas_map + ura_subzones_map + 
  moe_zone_map + moe_cluster_map +
  school_obesity_map +
  tm_title("Overview of overweight prevalence in Singapore schools")
```

## Obesity prevalence by educational level

We examine overweight prevalence in Singapore schools by educational level: Primary school or Secondary school. Primary school and secondary school students have different characteristics that might affect overweight prevalence.

The spatial mean centre (unweighted) and spatial variance (using the standard deviation distance and standard deviation ellipse) are calculated and plotted for each educational level.

### by Primary School

```{r}
tmap_mode("view")

# filter out by educational level and remove NA values to calculate SDE
obesity_pri_sch <- obesity_data_sf_2023_OSO %>% 
  filter(LEVEL == "PRIMARY", !is.na(PREVALENCE))

obesity_data_sf_2023_OSO %>% summary()

# Mean centre, standard deviation distance, standard deviation ellipse
pri_sch_mean <- calc_mnc(id = 1, points = st_coordinates(obesity_pri_sch))
pri_sch_median <- calc_mdc(id = 2, points = st_coordinates(obesity_pri_sch))
pri_sch_mean_median <- rbind(pri_sch_mean$LOCATIONS, pri_sch_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
pri_sch_mean_median$id = c("Spatial mean", "Spatial median")

pri_sch_sdd <- calc_sdd(id = 3, points = st_coordinates(obesity_pri_sch))
pri_sch_sdd_line <- pri_sch_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_sde <- calc_sde(id = 4, points = st_coordinates(obesity_pri_sch))
pri_sch_sde_line <- pri_sch_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = obesity_pri_sch$PREVALENCE,
  points = st_coordinates(obesity_pri_sch))
pri_sch_sde_weighted_line <- pri_sch_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_map <- ura_regions_map +
  tm_shape(obesity_pri_sch, name = "Overweight prevalence") +
  tm_symbols(
    size = "PREVALENCE",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

pri_sch_map +
  tm_shape(pri_sch_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(pri_sch_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(pri_sch_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(pri_sch_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Overweight prevalence in Primary Schools")
```

### by Secondary School

```{r}
tmap_mode("view")

# filter out by educational level and remove NA values to calculate SDE
obesity_sec_sch <- obesity_data_sf_2023_OSO %>% 
  filter(LEVEL == "SECONDARY", !is.na(PREVALENCE))

# Mean centre, standard deviation distance, standard deviation ellipse
sec_sch_mean <- calc_mnc(id = 1, points = st_coordinates(obesity_sec_sch))
sec_sch_median <- calc_mdc(id = 2, points = st_coordinates(obesity_sec_sch))
sec_sch_mean_median <- rbind(sec_sch_mean$LOCATIONS, sec_sch_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
sec_sch_mean_median$id = c("Spatial mean", "Spatial median")

sec_sch_sdd <- calc_sdd(id = 3, points = st_coordinates(obesity_sec_sch))
sec_sch_sdd_line <- sec_sch_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_sde <- calc_sde(id = 4, points = st_coordinates(obesity_sec_sch))
sec_sch_sde_line <- sec_sch_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = obesity_sec_sch$PREVALENCE,
  points = st_coordinates(obesity_sec_sch))
sec_sch_sde_weighted_line <- sec_sch_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_map <- ura_regions_map +
  tm_shape(obesity_sec_sch, name = "Overweight prevalence") +
  tm_symbols(
    shape = 22,
    size = "PREVALENCE",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

sec_sch_map +
  tm_shape(sec_sch_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(sec_sch_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(sec_sch_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(sec_sch_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Overweight prevalence in Secondary Schools")

# tmap_arrange(pri_sch_map, sec_sch_map, nrow = 1)
```

Generally, we observe greater overweight prevalence levels for schools in the North and lower overweight prevalence levels in the South and Central regions of Singapore.

## Obesity prevalence by region

We aggregate overweight counts and school enrollment data by the different delimited regions, and fill in the regions to get visualise overweight prevalence by region.

```{r}
# Aggregating overweight counts by URA regions
obesity_ura_regions <- st_join(ura_regions, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(REGION_N, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_regions_map + obesity_ura_regions %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    # fill.scale = tm_scale_continuous(values = "brewer.yl_or_rd"), 
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      # orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA regions") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by URA planning areas
obesity_ura_planning_areas <- st_join(ura_planning_areas, obesity_data_sf) %>%
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(PLN_AREA_N, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_planning_areas_map + obesity_ura_planning_areas %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA planning areas") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by URA subzones
obesity_ura_subzones <- st_join(ura_subzones, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(SUBZONE_N, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_subzones_map + obesity_ura_subzones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA subzones") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by MOE school zones
obesity_moe_zones <- 
  # we left_join instead of st_join due to overlapping boundaries
  left_join(moe_zones, st_drop_geometry(obesity_data_sf)) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(ZONE, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

moe_zone_map +
  tm_legend_hide() + 
  obesity_moe_zones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill_alpha = 0.95,
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1,
      show = T
      )
    ) +
  tm_title("Overweight prevalence by MOE clusters") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by MOE clusters
obesity_moe_clusters <- 
  left_join(moe_clusters, st_drop_geometry(obesity_data_sf)) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(CLUSTER, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

moe_cluster_map + obesity_moe_clusters %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill_alpha = 0.95,
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1,
      show = T
      )
    ) +
  tm_title("Overweight prevalence by MOE clusters") +
  tm_facets_wrap(by = "LEVEL")
```

# Region based analysis (Contiguous neighbouring regions)

There are too few contiguous neighbours by URA region to analyse meaningfully (only 5 URA regions). When analysing by URA subzone, there are too many non-contiguous subzones. We recommend to only analyse by URA planning area, which has some non-contiguous neighbours in the central regions. These non-contiguous neighbours by planning area are then manually edited (in the .gal file) to create neighbours with nearest planning areas to ensure contiguity for spatial statistical tests.

## Contiguous neighbours by URA regions

```{r}
obesity_ura_regions_pri <- obesity_ura_regions %>% filter(LEVEL == "PRIMARY")
ura_regions_nb_pri <- obesity_ura_regions_pri %>% poly2nb(queen = T)
ura_regions_nb_line_pri <- ura_regions_nb_pri %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_regions_pri)))
pri_map <- ura_regions_nb_line_pri %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_regions_pri)) %>% tm_shape() + tm_symbols()

obesity_ura_regions_sec <- obesity_ura_regions %>% filter(LEVEL == "SECONDARY")
ura_regions_nb_sec <- obesity_ura_regions_sec %>% poly2nb(queen = T)
ura_regions_nb_line_sec <- ura_regions_nb_sec %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_regions_sec)))
sec_map <- ura_regions_nb_line_sec %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_regions_sec)) %>% tm_shape() + tm_symbols()

tmap_arrange(pri_map, sec_map)
```

## Contiguous neighbours by URA planning areas

```{r}
obesity_ura_planning_areas_pri <- obesity_ura_planning_areas %>% filter(LEVEL == "PRIMARY")
ura_planning_areas_nb_pri <- obesity_ura_planning_areas_pri %>% poly2nb(queen = T)
ura_planning_areas_nb_line_pri <- ura_planning_areas_nb_pri %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_planning_areas_pri)))
pri_map <- ura_planning_areas_nb_line_pri %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_planning_areas_pri)) %>% 
  tm_shape() + tm_symbols()

obesity_ura_planning_areas_sec <- obesity_ura_planning_areas %>% filter(LEVEL == "SECONDARY")
ura_planning_areas_nb_sec <- obesity_ura_planning_areas_sec %>% poly2nb(queen = T)
ura_planning_areas_nb_line_sec <- ura_planning_areas_nb_sec %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_planning_areas_sec)))
sec_map <- ura_planning_areas_nb_line_sec %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_planning_areas_sec)) %>% 
  tm_shape() + tm_symbols()

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
ura_planning_areas_lw_pri <- 
  nb2listw(ura_planning_areas_nb_pri, style = "W", zero.policy = T)
ura_planning_areas_lw_B_pri <- 
  nb2listw(ura_planning_areas_nb_pri, style = "B", zero.policy = T)
obesity_ura_planning_areas_pri$HIGH_PREVALENCE <- 
  as.factor(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)
ura_regions_map + obesity_ura_planning_areas_pri %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(fill = "HIGH_PREVALENCE") +
  tm_title("Overweight prevalence by URA planning areas")
joincount.multi(obesity_ura_planning_areas_pri$HIGH_PREVALENCE, 
                listw = ura_planning_areas_lw_B_pri) 

# by Secondary school
ura_planning_areas_lw_sec <- 
  nb2listw(ura_planning_areas_nb_sec, style = "W", zero.policy = T)
ura_planning_areas_lw_B_sec <- 
  nb2listw(ura_planning_areas_nb_sec, style = "B", zero.policy = T)
obesity_ura_planning_areas_sec$HIGH_PREVALENCE <- 
  as.factor(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)
ura_regions_map + obesity_ura_planning_areas_sec %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(fill = "HIGH_PREVALENCE") +
  tm_title("Overweight prevalence by URA planning areas")
joincount.multi(obesity_ura_planning_areas_sec$HIGH_PREVALENCE, 
                listw = ura_planning_areas_lw_B_sec)
```

#### Moran's I statistic

```{r}
# by Primary school
moran.test(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw_pri)
moran.plot(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw_pri, 
           main="Moran scatterplot", 
           labels = F)

# by Secondary school
moran.test(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw_sec)
moran.plot(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw_sec, 
           main="Moran scatterplot", 
           labels = F)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_ura_planning_areas_pri <- 
  localmoran(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
             listw = ura_planning_areas_lw_pri)
obesity_ura_planning_areas_pri$LMORANZ <- localm_ura_planning_areas_pri[,4]
tm_shape(obesity_ura_planning_areas_pri) + tm_polygons(fill = "LMORANZ") + 
  tm_title("Local Moran's I Z-Statistic (URA planning areas)")

# by Secondary school
localm_ura_planning_areas_sec <- 
  localmoran(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
             listw = ura_planning_areas_lw_sec)
obesity_ura_planning_areas_sec$LMORANZ <- localm_ura_planning_areas_sec[,4]
tm_shape(obesity_ura_planning_areas_sec) + tm_polygons(fill = "LMORANZ") + 
  tm_title("Local Moran's I Z-Statistic (URA planning areas)")
```

#### Geary's C statistic
```{r}
# by Primary school
geary.test(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw_pri)

# by Secondary school
geary.test(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw_sec)
```

#### Getis-Ord's G statistics
```{r}
# by Primary school
globalG.test(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE,
             listw = ura_planning_areas_lw_B_pri)

# by Secondary school
globalG.test(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE,
             listw = ura_planning_areas_lw_B_sec)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_ura_planning_areas_pri$GO_STAT <-
  localG(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
         listw = ura_planning_areas_lw_B_pri)
tm_shape(obesity_ura_planning_areas_pri) + tm_polygons("GO_STAT")

# by Secondary school
obesity_ura_planning_areas_sec$GO_STAT <-
  localG(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
         listw = ura_planning_areas_lw_B_sec)
tm_shape(obesity_ura_planning_areas_sec) + tm_polygons("GO_STAT")
```

#### Correlogram
```{r}
# by Primary school
correl_planning_areas_pri <- sp.correlogram(
  neighbours = ura_planning_areas_nb_pri, 
  var = obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
  order = 3, method = "corr", style = "W", zero.policy = T)
correlI_planning_areas_pri <- sp.correlogram(
  neighbours = ura_planning_areas_nb_pri, 
  var = obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
  order = 3, method = "I", style = "W", zero.policy = T)
correlC_planning_areas_pri <- sp.correlogram(
  neighbours = ura_planning_areas_nb_pri, 
  var = obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE,
  order = 3, method = "C", style = "W", zero.policy = T)
par(mfrow=c(1,3))
plot(correl_planning_areas_pri, main="Contiguity lag orders: correlation")
plot(correlI_planning_areas_pri, main="Contiguity lag orders: Moran's I")
plot(correlC_planning_areas_pri, main="Contiguity lag orders: Geary's C")
par(mfrow=c(1,1))

# by Secondary school
correl_planning_areas_sec <- sp.correlogram(
  neighbours = ura_planning_areas_nb_sec, 
  var = obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
  order = 3, method = "corr", style = "W", zero.policy = T)
correlI_planning_areas_sec <- sp.correlogram(
  neighbours = ura_planning_areas_nb_sec, 
  var = obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
  order = 3, method = "I", style = "W", zero.policy = T)
correlC_planning_areas_sec <- sp.correlogram(
  neighbours = ura_planning_areas_nb_sec, 
  var = obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE,
  order = 3, method = "C", style = "W", zero.policy = T)
par(mfrow=c(1,3))
plot(correl_planning_areas_sec, main="Contiguity lag orders: correlation")
plot(correlI_planning_areas_sec, main="Contiguity lag orders: Moran's I")
plot(correlC_planning_areas_sec, main="Contiguity lag orders: Geary's C")
par(mfrow=c(1,1))
```

## Contiguous neighbours by URA subzones

```{r}
obesity_ura_subzones_pri <- obesity_ura_subzones %>% filter(LEVEL == "PRIMARY")
ura_subzones_nb_pri <- obesity_ura_subzones_pri %>% poly2nb(queen = T)
ura_subzones_nb_line_pri <- ura_subzones_nb_pri %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_subzones_pri)))
pri_map <- ura_subzones_nb_line_pri %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_subzones_pri)) %>% tm_shape() + tm_symbols()

obesity_ura_subzones_sec <- obesity_ura_subzones %>% filter(LEVEL == "SECONDARY")
ura_subzones_nb_sec <- obesity_ura_subzones_sec %>% poly2nb(queen = T)
ura_subzones_nb_line_sec <- ura_subzones_nb_sec %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_subzones_sec)))
sec_map <- ura_subzones_nb_line_sec %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_subzones_sec)) %>% tm_shape() + tm_symbols()

tmap_arrange(pri_map, sec_map)
```

# Cluster based analysis (Social distance) (does not work)

## MOE clusters

```{r}
moe_clusters_nb_pri <- read.gal("clusters.gal")
obesity_moe_clusters_pri <- obesity_moe_clusters %>% filter(LEVEL == "PRIMARY")
```

### Spatial autocorrelation statistics

```{r}
moe_clusters_lw_pri <- nb2listw(moe_clusters_nb_pri)
moran.test(obesity_moe_clusters_pri$PREVALENCE_AGGREGATE, moe_clusters_lw_pri)
moran.plot(obesity_moe_clusters_pri$PREVALENCE_AGGREGATE, moe_clusters_lw_pri)
geary.test(obesity_moe_clusters_pri$PREVALENCE_AGGREGATE, moe_clusters_lw_pri)
```

# Graph neighbours based analysis

## Delauney triangulation neighbours

```{r}
# by Primary schools
# obesity_pri_sch_jitter <- st_jitter(obesity_pri_sch) 
del_nb_pri <- tri2nb(st_coordinates(obesity_pri_sch), 
                     row.names = obesity_pri_sch_jitter$PT_ID) 
pri_map <- tm_shape(nb2lines(del_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
# obesity_sec_sch_jitter <- st_jitter(obesity_sec_sch) 
del_nb_sec <- tri2nb(st_coordinates(obesity_sec_sch), 
                     row.names = obesity_sec_sch_jitter$PT_ID) 
sec_map <- tm_shape(nb2lines(del_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(del_lw_pri <- nb2listw(del_nb_pri))
moran.test(obesity_pri_sch$PREVALENCE, del_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, del_lw_pri)
geary.test(obesity_pri_sch$PREVALENCE, del_lw_pri)

# by Secondary schools
(del_lw_sec <- nb2listw(del_nb_sec))
moran.test(obesity_sec_sch$PREVALENCE, del_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, del_lw_sec)
geary.test(obesity_sec_sch$PREVALENCE, del_lw_sec)
```

Average number of links (Primary school): 5.823204 
p-value for Moran's test (Primary school): 4.515e-10
p-value for Geary C's test (Primary school): 9.073e-10

Average number of links (Secondary school): 5.805556 
p-value for Moran's test (Secondary school): 0.0001695
p-value for Geary C's test (Secondary school): 9.452e-05

## Sphere of influence neighbours

```{r}
# by Primary schools
if (require(dbscan, quietly=TRUE)) {
  soi_nb_pri <- graph2nb(soi.graph(del_nb_pri, st_geometry(obesity_pri_sch)))
} else {
  soi_nb = NULL
}
soi_lw_pri <- nb2listw(soi_nb_pri)

# by Secondary schools
if (require(dbscan, quietly=TRUE)) {
  soi_nb_sec <- graph2nb(soi.graph(del_nb_sec, st_geometry(obesity_sec_sch)))
} else {
  soi_nb = NULL
}
soi_lw_sec <- nb2listw(soi_nb_sec)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(soi_lw_pri <- nb2listw(soi_nb_pri))
moran.test(obesity_pri_sch$PREVALENCE, soi_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, soi_lw_pri)
geary.test(obesity_pri_sch$PREVALENCE, soi_lw_pri)

# by Secondary schools
(soi_lw_sec <- nb2listw(soi_nb_sec))
moran.test(obesity_sec_sch$PREVALENCE, soi_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, soi_lw_sec)
geary.test(obesity_sec_sch$PREVALENCE, soi_lw_sec)
```

Average number of links (Primary school): 3.082873 
p-value for Moran's test (Primary school): 2.581e-06
p-value for Geary C's test (Primary school): 2.736e-06

Average number of links (Secondary school): 2.958333 
p-value for Moran's test (Secondary school): 0.0004617
p-value for Geary C's test (Secondary school): 0.0002675

# K nearest neighbour based analysis

## 1 neighbour
```{r}
# by Primary schools
knn1_nb_pri <- obesity_pri_sch %>% 
  knearneigh(k = 1) %>% 
  knn2nb(row.names = obesity_pri_sch$PT_ID) # nearest neighbour
pri_map <- tm_shape(nb2lines(knn1_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
knn1_nb_sec <- obesity_sec_sch %>% 
  knearneigh(k = 1) %>% 
  knn2nb(row.names = obesity_sec_sch$PT_ID) # nearest neighbour
sec_map <- tm_shape(nb2lines(knn1_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(knn1_lw_pri <- nb2listw(knn1_nb_pri))
moran.test(obesity_pri_sch$PREVALENCE, knn1_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, knn1_lw_pri)
geary.test(obesity_pri_sch$PREVALENCE, knn1_lw_pri)

# by Secondary schools
(knn1_lw_sec <- nb2listw(knn1_nb_sec))
moran.test(obesity_sec_sch$PREVALENCE, knn1_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, knn1_lw_sec)
geary.test(obesity_sec_sch$PREVALENCE, knn1_lw_sec)
```

Average number of links (Primary school): 1 
p-value for Moran's test (Primary school): 0.008449
p-value for Geary C's test (Primary school): 0.04445

Average number of links (Secondary school): 1 
p-value for Moran's test (Secondary school): 0.0004819
p-value for Geary C's test (Secondary school): 0.004126

## 2 neighbours
```{r}
# by Primary schools
knn2_nb_pri <- obesity_pri_sch %>% 
  knearneigh(k = 2) %>% 
  knn2nb(row.names = obesity_pri_sch$PT_ID) # nearest neighbour
pri_map <- tm_shape(nb2lines(knn2_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
knn2_nb_sec <- obesity_sec_sch %>% 
  knearneigh(k = 2) %>% 
  knn2nb(row.names = obesity_sec_sch$PT_ID) # nearest neighbour
sec_map <- tm_shape(nb2lines(knn2_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(knn2_lw_pri <- nb2listw(knn2_nb_pri))
moran.test(obesity_pri_sch$PREVALENCE, knn2_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, knn2_lw_pri)
geary.test(obesity_pri_sch$PREVALENCE, knn2_lw_pri)

# by Secondary schools
(knn2_lw_sec <- nb2listw(knn2_nb_sec))
moran.test(obesity_sec_sch$PREVALENCE, knn2_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, knn2_lw_sec)
geary.test(obesity_sec_sch$PREVALENCE, knn2_lw_sec)
```

Average number of links (Primary school): 2
p-value for Moran's test (Primary school): 6.805e-05
p-value for Geary C's test (Primary school): 0.000133

Average number of links (Secondary school): 2
p-value for Moran's test (Secondary school): 0.003471
p-value for Geary C's test (Secondary school): 0.03461

## 3 neighbours
```{r}
# by Primary schools
knn3_nb_pri <- obesity_pri_sch %>% 
  knearneigh(k = 3) %>% 
  knn2nb(row.names = obesity_pri_sch$PT_ID) # nearest neighbour
pri_map <- tm_shape(nb2lines(knn3_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
knn3_nb_sec <- obesity_sec_sch %>% 
  knearneigh(k = 3) %>% 
  knn2nb(row.names = obesity_sec_sch$PT_ID) # nearest neighbour
sec_map <- tm_shape(nb2lines(knn3_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(knn3_lw_pri <- nb2listw(knn3_nb_pri))
moran.test(obesity_pri_sch$PREVALENCE, knn3_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, knn3_lw_pri)
geary.test(obesity_pri_sch$PREVALENCE, knn3_lw_pri)

# by Secondary schools
(knn3_lw_sec <- nb2listw(knn3_nb_sec))
moran.test(obesity_sec_sch$PREVALENCE, knn3_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, knn3_lw_sec)
geary.test(obesity_sec_sch$PREVALENCE, knn3_lw_sec)
```

Average number of links (Primary school): 3
p-value for Moran's test (Primary school): 2.337e-06
p-value for Geary C's test (Primary school): 1.103e-06

Average number of links (Secondary school): 3
p-value for Moran's test (Secondary school): 0.000427
p-value for Geary C's test (Secondary school): 0.002858

# Income distribution (Lucas)

```{r}
census <- read.csv("census stats.csv") %>% 
  mutate(PLN_AREA_N = toupper(PLN_AREA_N))

census_merge <- ura_planning_areas %>%
  left_join(census)

ura_planning_areas_map + tm_shape(census_merge) +
  tm_polygons(fill = "Income")

ura_planning_areas_map + tm_shape(census_merge) +
  tm_polygons(fill="Education")

tm_shape(combine_data) + 
  tm_fill(fill="Income", 
          fill.scale = tm_scale(breaks = c(6925,8396,9532,11317,16197))
          ) +
  tm_title("Breakdown by Household Income")
tm_shape(combine_data) + 
  tm_fill(fill="Education", 
          fill.scale = tm_scale(breaks = c(9.76,10.74,11.25,11.89,14.78))
          ) +
  tm_title("Breakdown by Education Level")
tm_shape(combine_data) + 
  tm_fill(fill="Primary", 
          fill.scale = tm_scale(breaks = c(61,4778,7043,11681,21822))
          ) +
  tm_title("Breakdown by Pri Students")
tm_shape(combine_data) + 
  tm_fill(fill="Secondary", 
          fill.scale = tm_scale(breaks=c(59,3526,4894,8804,13221))
          ) +
  tm_title("Breakdown by Sec Students")
```

# Spatial Descriptive Summary Measures of Income (Lucas)

```{r}
census_coords <- st_coordinates(census_merge)
income_mean <- calc_mnc(id = 1, points = census_coords, weighted = T, weights = census_merge$Income)
income_median <- calc_mdc(id = 2, points = census_coords)
income_mean_median <- rbind(income_mean$LOCATIONS, income_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
income_mean_median$id = c("Weighted mean", "Weighted median")

income_sdd <- calc_sdd(id = 3, points = census_coords)
income_sdd_line <- income_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_sde <- calc_sde(id = 4, points = census_coords)
income_sde_line <- income_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = census_merge$Income,
  points = census_coords)
income_sde_weighted_line <- income_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_map <- ura_planning_area_map +
    tm_shape(census_merge, name = "Income") +
    tm_symbols(
        size = "Income",
        size.scale = tm_scale_continuous(values.scale = 0.8),
        size.legend = tm_legend_hide(),
        fill = "Income", 
        # a green-red diverging scale to indicate severity of overweight prevalence
        fill.scale = tm_scale_continuous(values = "brewer.yl_or_rd"), 
        fill.legend = tm_legend(
            title = "Income Distribution",
            orientation = "landscape", 
            position = c("BOTTOM", "LEFT"),
            item.height = 0.5, item.width = 2.1
        )
    ) + 
    tm_shape(income_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
    tm_shape(income_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
    tm_shape(income_sde_weighted_line, name = "weighted SDE") + 
    tm_lines(col = "red", lwd = 2, lty = 3) +
    tm_shape(income_mean_median, name = "Summary measures") + tm_dots(
        size = 0.5, shape = "id", fill = "white", 
        shape.legend = tm_legend("Summary measures")
    ) + 
    tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
    tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
    tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
    tm_title("Income Distribution across SG Planning Areas")

print(income_map)
```

# Spatial Descriptive Summary Measures of Education Years (Lucas)

```{r}
education_mean <- calc_mnc(id = 1, points = census_coords, weighted = T, weights = census_merge$Education)
education_median <- calc_mdc(id = 2, points = census_coords)
education_mean_median <- rbind(education_mean$LOCATIONS, education_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
education_mean_median$id = c("Weighted mean", "Weighted median")

education_sdd <- calc_sdd(id = 3, points = census_coords)
education_sdd_line <- education_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_sde <- calc_sde(id = 4, points = census_coords)
education_sde_line <- education_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = census_merge$Education,
  points = census_coords)
education_sde_weighted_line <- education_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_map <- ura_planning_area_map +
    tm_shape(census_merge, name = "Education") +
    tm_symbols(
        size = "Education",
        size.scale = tm_scale_continuous(values.scale = 0.8),
        size.legend = tm_legend_hide(),
        fill = "Education", 
        # a green-red diverging scale to indicate severity of overweight prevalence
        fill.scale = tm_scale_continuous(values = "brewer.yl_or_rd"), 
        fill.legend = tm_legend(
            title = "Education Years",
            orientation = "landscape", 
            position = c("BOTTOM", "LEFT"),
            item.height = 0.5, item.width = 2.1
        )
    ) + 
    tm_shape(education_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
    tm_shape(education_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
    tm_shape(education_sde_weighted_line, name = "weighted SDE") + 
    tm_lines(col = "red", lwd = 2, lty = 3) +
    tm_shape(education_mean_median, name = "Summary measures") + tm_dots(
        size = 0.5, shape = "id", fill = "white", 
        shape.legend = tm_legend("Summary measures")
    ) + 
    tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
    tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
    tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
    tm_title("Education Years Across SG Planning Areas")

print(education_map)
```

# Food and Nutrition (Nina)

```{r}
#Data transformation

#Hawker Centres
hawker_full = st_read("NEAMarketandFoodCentre.geojson") %>%
  st_transform(crs = sg_crs)
hawker = hawker_full["geometry"]

#Fast Food Outlets 
  #Mcdonald's
macs_full = st_read("mcdonalds_singapore.geojson") %>%
  st_transform(crs = sg_crs) 
table(st_is_valid(macs_full)) #Check validity
st_crs(macs_full)$epsg #Check CRS
macs = macs_full[,"geometry"] #Extract necessary columns for analysis

  #7-11 Outlets
seven_eleven_full = st_read("711_singapore.geojson") %>%
  st_transform(crs = sg_crs)
seven_eleven = seven_eleven_full[,"geometry"] #Extract necessary columns for analysis
table(st_is_valid(seven_eleven)) #Check validity
st_crs(seven_eleven)$epsg #Check CRS

#Combine data into single SF object
seven_eleven_sf = mutate(seven_eleven, outlet = "7-11")
macs_sf = mutate(macs, outlet = "mcdonalds")
hawker_sf = mutate(hawker, outlet = "hawker")
food = rbind(seven_eleven_sf, macs_sf, hawker_sf)


##### Primary school analysis
obesity_pri_food = obesity_pri_sch #duplicate primary school data
st_crs(obesity_pri_food)$units #check units
pri_schools_buffer1 <- st_buffer(obesity_pri_food, dist = 1000) %>% st_geometry()
pri_intersections <- st_intersects(pri_schools_buffer1, food)

#Calculate the number of food outlets within a 1km radius of each school
obesity_pri_food$num_food_outlets <- lengths(pri_intersections)
obesity_pri_food

#Show density via choropleth map
pri_food_map = ura_regions_map + 
  tm_shape(obesity_pri_food) +
  tm_symbols(
    size = 0.5,
    fill = "num_food_outlets"
  ) +
  tm_title("Food Outlet Density by Primary School")

print(pri_food_map)


####Secondary school analysis
obesity_sec_food = obesity_sec_sch #duplicate secondary school data
st_crs(obesity_sec_food)$units #check units
sec_schools_buffer1 <- st_buffer(obesity_sec_food, dist = 1000) %>% st_geometry()
sec_intersections <- st_intersects(sec_schools_buffer1, food)

#calculate the number of food outlets within a 1km radius of each school
obesity_sec_food$num_food_outlets <- lengths(sec_intersections)
obesity_sec_food

#show density via choropleth map
sec_food_map = ura_regions_map + 
  tm_shape(obesity_sec_food) +
  tm_symbols(
    size = 0.5,
    fill = "num_food_outlets"
  ) +
  tm_title("Food Outlet Density by Secondary School")

print(sec_food_map)

###Spatial analysis - Secondary school
st_crs(obesity_sec_food)$proj #Check for metric units
obesity_sec_food_coords = st_coordinates(obesity_sec_food)

mean_sec_food = calc_mnc(id = 1, points = obesity_sec_food_coords)
median_sec_food = calc_mdc(id = 2, points = obesity_sec_food_coords)
sdd_sec_food = calc_sdd(id = 3, calccentre = T, weighted = F, points = obesity_sec_food_coords)

LC_sdd_line_sec_food = sdd_sec_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_sec_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING") # CRS from the parent object.

sde_sec_food = calc_sde(id=4, calccentre = T, weighted=F, points= obesity_sec_food_coords)
ls()
LC_sde_line_sec = sde_sec_food$LOCATIONS %>%
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_sec_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING") # CRS from the parent object.

(LC_sdd_line_sec = sdd_sec_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_sec_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING")) # CRS from the parent object.

(LC_std_dist_sec = st_sf(sdd_sec_food$ATTRIBUTES, geom=st_geometry(LC_sdd_line_sec))) 

LC_std_ellps_sec = st_sf(sde_sec_food$ATTRIBUTES, geom = st_geometry(LC_sde_line_sec))

#Plot the summary measures
(mean_median_sec = rbind(mean_sec_food$LOCATIONS, median_sec_food$LOCATIONS) %>% 
    data.frame() %>% 
    st_as_sf(coords=c("x","y"), crs=st_crs(obesity_sec_food))) # matrix -> data.frame -> sf points

mean_median_sec$id =  c("Spatial Mean","Spatial Median") # assign names
mean_median_sec

sec_food_map + 
  tm_shape(obesity_sec_food) +
  tm_shape(LC_std_ellps_sec) + tm_lines(lwd=2) + 
  tm_shape(LC_std_dist_sec) + tm_lines(lwd=2, lty=2) + 
  tm_shape(mean_median_sec) + tm_dots(size=0.5, shape="id", fill = "white", shape.legend = tm_legend_hide()) + 
  tm_compass(position = c("left", "top")) +
  tm_add_legend(type="symbols", labels="Spatial mean", shape = 1) +
  tm_add_legend(type="symbols", labels="Spatial median", shape = 0) +
  tm_add_legend(type="lines", labels="SDD", lty=2) + 
  tm_add_legend(type="lines", labels="SDE", lty=1)


##Spatial analysis - Primary school
st_crs(obesity_pri_food)$proj #Check for metric units 
obesity_pri_food_coords = st_coordinates(obesity_pri_food)

mean_pri_food = calc_mnc(id = 1, points = obesity_pri_food_coords)
median_pri_food = calc_mdc(id = 2, points = obesity_pri_food_coords)
sdd_pri_food = calc_sdd(id = 3, calccentre = T, weighted = F, points = obesity_pri_food_coords)

(LC_sdd_line_pri_food = sdd_pri_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_pri_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING")) # CRS from the parent object.

sde_pri_food = calc_sde(id=4, calccentre = T, weighted=F, points= obesity_pri_food_coords)
ls()
LC_sde_line_pri = sde_pri_food$LOCATIONS %>%
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_pri_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING") # CRS from the parent object.


(LC_sdd_line_pri = sdd_pri_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_pri_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING")) # CRS from the parent object.

(LC_std_dist_pri = st_sf(sdd_pri_food$ATTRIBUTES, geom=st_geometry(LC_sdd_line_pri))) 

LC_std_ellps_pri = st_sf(sde_pri_food$ATTRIBUTES, geom = st_geometry(LC_sde_line_pri))

#Plot the summary measures 
(mean_median_pri = rbind(mean_pri_food$LOCATIONS, median_pri_food$LOCATIONS) %>% 
    data.frame() %>% 
    st_as_sf(coords=c("x","y"), crs=st_crs(obesity_pri_food))) # matrix -> data.frame -> sf points

mean_median_pri$id =  c("Spatial Mean","Spatial Median") # assign names
mean_median_pri

pri_food_map + 
  tm_shape(obesity_pri_food) +
  tm_shape(LC_std_ellps_pri) + tm_lines(lwd=2) + 
  tm_shape(LC_std_dist_pri) + tm_lines(lwd=2, lty=2) + 
  tm_shape(mean_median_pri) + tm_dots(size=0.5, shape="id", fill = "white", shape.legend = tm_legend_hide()) + 
  tm_compass(position = c("left", "top")) +
  tm_add_legend(type="symbols", labels="Spatial mean", shape = 1) +
  tm_add_legend(type="symbols", labels="Spatial median", shape = 0) +
  tm_add_legend(type="lines", labels="SDD", lty=2) + 
  tm_add_legend(type="lines", labels="SDE", lty=1)
```




# Sports CCAs in Schools (Qasim)

```{r}
# Loading school co-curricular activities data
school_sports_ccas <- 
  read.csv("CocurricularactivitiesCCAs.csv") %>% 
  group_by(school_name,school_section) %>% 
  summarise(
    total = n(),
    physical_sports_count = sum(cca_grouping_desc == "PHYSICAL SPORTS")) %>% 
    select(school_name,school_section, physical_sports_count) %>% 
    filter(school_section != "JUNIOR COLLEGE")
  


#2023 OSO school obesity data combined with 2024-25 school physical activity cca data
#gives spatial awareness to physical activity cca by joining to obesity data set by school name
obesity_joined_school_sports_data <- 
  obesity_data_sf_2023_OSO %>% 
  left_join(school_sports_ccas, by = join_by(SCHOOL == school_name)) %>%
  mutate(sports_cca_per_100 = physical_sports_count / ENROLMENT * 100, #ratio of sports cca per 100 students
         LEVEL = case_when(
           LEVEL == "PRIMARY + SECONDARY" & PRI == 1 ~ "PRIMARY",
           LEVEL == "PRIMARY + SECONDARY" & PRI == 0 ~ "SECONDARY",
           TRUE ~ LEVEL
         )
        ) 

```

#Visualising physical sports participation by school level

###########################PRIMARY SCHOOL####################################

```{r}
# Primary school sports participation

#NEED TO AVERAGE VALUES FOR MISSING VALUES
pri_cca_data <- obesity_joined_school_sports_data %>% filter(LEVEL == "PRIMARY", !is.na(sports_cca_per_100))

pri_cca_map <- ura_planning_areas_map+  
  tm_shape(pri_cca_data) +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    shape = 21,  # circle
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"),
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
    )
  ) + 
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Ratio of Sports CCAs per 100 Students by Primary School"
  )

pri_cca_map 

pri_cca_data %>% summary()

# Spatial descriptive summary measures of physical sports participation by primary school

# Mean centre, standard deviation distance, standard deviation ellipse
pri_cca_mean <- calc_mnc(id = 1, points = st_coordinates(pri_cca_data))
pri_cca_median <- calc_mdc(id = 2, points = st_coordinates(pri_cca_data))
pri_cca_mean_median <- rbind(pri_cca_mean$LOCATIONS, pri_cca_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
pri_cca_mean_median$id = c("Spatial mean", "Spatial median")

pri_cca_sdd <- calc_sdd(id = 3, points = st_coordinates(pri_cca_data))
pri_cca_sdd_line <- pri_cca_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_sde <- calc_sde(id = 4, points = st_coordinates(pri_cca_data))
pri_cca_sde_line <- pri_cca_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = pri_cca_data$sports_cca_per_100,
  points = st_coordinates(pri_cca_data))
pri_cca_sde_weighted_line <- pri_cca_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_map_sde <- ura_planning_areas_map +
  tm_shape(pri_cca_data, name = "Ratio of Sports CCAs per 100 Students by School") +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(pri_cca_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(pri_cca_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(pri_cca_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(pri_cca_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Ratio of Sports CCAs per 100 Students by Primary School")

pri_cca_map_sde

```


####################################SECONDARY SCHOOL####################################
```{r}
sec_cca_data <- obesity_joined_school_sports_data %>% filter(LEVEL == "SECONDARY", !is.na(sports_cca_per_100))

sec_cca_map <- ura_planning_areas_map +  
  tm_shape(sec_cca_data) +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    shape = 22,  #square
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"),
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
    )
  ) + 
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Ratio of Sports CCAs per 100 Students by Secondary School"
  )


sec_cca_map

sec_cca_data %>% summary()
# Spatial descriptive summary measures of physical sports participation by primary school

# Mean centre, standard deviation distance, standard deviation ellipse
sec_cca_mean <- calc_mnc(id = 1, points = st_coordinates(sec_cca_data))
sec_cca_median <- calc_mdc(id = 2, points = st_coordinates(sec_cca_data))
sec_cca_mean_median <- rbind(sec_cca_mean$LOCATIONS, sec_cca_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
sec_cca_mean_median$id = c("Spatial mean", "Spatial median")

sec_cca_sdd <- calc_sdd(id = 3, points = st_coordinates(sec_cca_data))
sec_cca_sdd_line <- sec_cca_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_sde <- calc_sde(id = 4, points = st_coordinates(sec_cca_data))
sec_cca_sde_line <- sec_cca_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = sec_cca_data$sports_cca_per_100,
  points = st_coordinates(sec_cca_data))
sec_cca_sde_weighted_line <- sec_cca_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_map_sde <- ura_planning_areas_map +
  tm_shape(sec_cca_data, name = "Ratio of Sports CCAs per 100 Students by School") +
  tm_symbols(
    shape = 22,
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(sec_cca_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(sec_cca_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(sec_cca_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(sec_cca_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Ratio of Sports CCAs per 100 Students by Secondary School")

sec_cca_map_sde


###################################################################




# Aggregating sports cca ratio counts by URA planning area
cca_planning_avg <- st_join(ura_planning_areas, obesity_joined_school_sports_data) %>% 
  group_by(PLN_AREA_N, LEVEL) %>% 
  summarise(
    RATIO_AGG = mean(sports_cca_per_100, na.rm = T),
    geometry = st_union(geometry)
    ) %>%
  filter(!is.na(RATIO_AGG))

cca_planning_avg_map <- ura_planning_areas_map + cca_planning_avg %>% 
  tm_shape(name = "Sports CCA Ratio per 100") +
  tm_polygons(
    fill = "RATIO_AGG",
    fill.scale = tm_scale(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Sports CCA Ratio by URA subzones") +
  tm_facets_wrap(by = "LEVEL")

print(cca_planning_avg_map)

```




```{r}
#WORK IN PROGRESS

#bivariate chloropleth for obesity prevalence and physical sports participation?


library(classInt);library(dplyr)

# 1️⃣ Select the two variables for the bivariate map
obesity_sports_data <- obesity_joined_school_sports_data %>% 
  filter(!is.na(sports_cca_per_100), !is.na(PREVALENCE)) %>%
  select(geometry, sports_cca_per_100, PREVALENCE)

# 2️⃣ Classify both variables into 3 categories (low, medium, high)
obesity_sports_data <- obesity_sports_data %>%
  mutate(
    sports_cat = cut(sports_cca_per_100, 
                     breaks = classIntervals(sports_cca_per_100, 3, style = "quantile")$brks, 
                     labels = c("Low", "Medium", "High"), 
                     include.lowest = TRUE),
    obesity_cat = cut(PREVALENCE, 
                      breaks = classIntervals(PREVALENCE, 3, style = "quantile")$brks, 
                      labels = c("Low", "Medium", "High"), 
                      include.lowest = TRUE)
  )

# 3️⃣ Combine the two classifications into one
obesity_sports_data <- obesity_sports_data %>%
  mutate(bivariate_class = paste(sports_cat, obesity_cat, sep = "_"))

# 4️⃣ Define a bivariate color scheme (3x3 grid)
bivariate_colors <- c(
  "Low_Low" = "#e8e8e8", "Medium_Low" = "#b4d3e4", "High_Low" = "#8bb5d1",
  "Low_Medium" = "#e4b4b4", "Medium_Medium" = "#b4b4b4", "High_Medium" = "#8b8b8b",
  "Low_High" = "#d18b8b", "Medium_High" = "#b58b8b", "High_High" = "#8b8b8b"
)

# 5️⃣ Create the bivariate choropleth map
bivariate_map <-ura_subzones_map +
  tm_shape(obesity_sports_data) +
  tm_polygons(fill = "bivariate_class", palette = bivariate_colors, title = "Bivariate Categories") +
  tm_layout(legend.position = c("right", "bottom"))

# 6️⃣ Print the map
bivariate_map


```





# Sports Fields and Facilities (Qasim)
```{r}
# Loading sports facilities data
sports_facilities_file <- "SportSGSportFacilities.geojson"
sports_facilities_sf <- st_read(sports_facilities_file) %>% 
  st_transform(crs = sg_crs)

st_make_valid(sports_facilities_sf) # Check for invalid geometries
st_as_sf(st_make_valid(sports_facilities_sf)) # Fix invalid geometries


sport_sg_facility_map <- ura_planning_areas_map + tm_shape(sports_facilities_sf) +
  tm_polygons(size = 0.3,
          fill = "slateblue4",
          fill.legend = tm_legend(title = "Sports Fields"))

sport_sg_facility_map



# Loading Sports fields data
fields_shp <- 
  st_read("SportsFieldsSGSHP/PLAYSG.shp") %>% 
  st_make_valid() %>%
  st_as_sf() %>%
  st_transform(crs = sg_crs) 

sports_fields_map <- ura_planning_areas_map + tm_shape(fields_shp) +
    tm_dots(size = 0.3,
          fill = "slateblue2",
          fill.legend = tm_legend(title = "Sports Fields"),
          fill_alpha = 0.5)


sports_fields_map



#DATA SET OF CHOICE
# Loading dual use facilities data

dual_use_facilities <- 
  st_read("DualUseSchoolsSportsFacilitiesSHP/DUS_School_Sports_Facilities.shp") %>% 
  st_make_valid() %>%
  st_as_sf() %>%
  st_transform(crs = sg_crs) 

dus_facility_map <- ura_planning_areas_map + tm_shape(dual_use_facilities) +
    tm_dots(size = 0.3,
          fill = "navy",
          fill.legend = tm_legend(title = "Dual Use School Sports Facilities"),
          fill_alpha = 0.5)

dus_facility_map




#displaying schools and sports facilities on the same map

#primary schools
pri_dus_map <- ura_planning_areas_map + 
  tm_shape(pri_cca_data) +
  tm_symbols(
    size = 0.3,
    fill = "red"
  ) +
  tm_shape(dual_use_facilities) +
  tm_dots(
    size = 0.3,
    fill = "blue"
  ) +
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Primary Schools and Dual Use Sports Facilities"
  )

pri_dus_map


#seconadry schools
sec_dus_map <- ura_planning_areas_map + 
  tm_shape(sec_cca_data) +
  tm_symbols(
    size = 0.3,
    fill = "red"
  ) +
  tm_shape(dual_use_facilities) +
  tm_dots(
    size = 0.3,
    fill = "blue"
  ) +
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Secondary Schools and Dual Use Sports Facilities"
  )

sec_dus_map

```

# K Nearest Neighbours

# K nearest neighbour based analysis 

#NEAREST SPORTS FACILITY TO SCHOOL

## 1 neighbour

```{r}
# K nearest neighbour based analysis 

#NEAREST SPORTS FACILITY TO SCHOOL


## 1 neighbour



class(dual_use_facilities)


# Calculate distances
distances <- st_distance(obesity_joined_school_sports_data, dual_use_facilities)

# For each school, find the k nearest facilities
k <- 3  # Change this to your desired k value
nearest_facilities <- list()

for (i in 1:nrow(obesity_joined_school_sports_data)) {
  # Get distances from this school to all facilities
  school_distances <- distances[i,]
  
  # Find indices of k nearest facilities (or fewer if there aren't k facilities)
  nearest_indices <- order(school_distances)[1:min(k, length(school_distances))]
  
  # Store these indices
  nearest_facilities[[i]] <- nearest_indices
}

# Create a data frame with the results
results <- data.frame(
  school_id = obesity_joined_school_sports_data$PT_ID,
  school_name = obesity_joined_school_sports_data$SCHOOL,
  level = obesity_joined_school_sports_data$LEVEL,
  stringsAsFactors = FALSE
)

# Add the nearest facilities for each school
for (j in 1:k) {
  facility_col <- paste0("nearest_facility_", j)
  distance_col <- paste0("distance_", j)
  
  results[[facility_col]] <- sapply(1:nrow(obesity_joined_school_sports_data),
  function(i) {
    if (length(nearest_facilities[[i]]) >= j) {
      # Return the ID of the jth nearest facility using the OBJECTID column
      dual_use_facilities$OBJECTID[nearest_facilities[[i]][j]]
    } else {
      NA
    }
  })
  
  results[[distance_col]] <- sapply(1:nrow(obesity_joined_school_sports_data),
  function(i) {
    if (length(nearest_facilities[[i]]) >= j) {
      # Return the distance to the jth nearest facility in meters
      as.numeric(distances[i, nearest_facilities[[i]][j]])
    } else {
      NA
    }
  })
}

pri_knn_3 <- results %>% filter(level == "PRIMARY") 
sec_knn_3 <- results %>% filter(level == "SECONDARY")


```

# Other Useful stuff

```{r}
tmap_mode("view") #interactive map
tmap_mode("plot") #static map
# tmap_save(tmap_object, 'xx.jpg') # for saving maps as images
cols4all::c4a_gui() # colour scales
RColorBrewer::display.brewer.all()
```
