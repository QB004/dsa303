---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Data loading, cleaning and transformation

## Loading the data

```{r}
# Loading libraries to work with spatial data
library(tidyverse); library(sf); library(tmap); library(aspace); library(spdep); library(corrplot); library(readxl)

# Loading Singapore URA subzone boundary data
sg_ura_boundaries <- 
  st_read("MasterPlan2014SubzoneBoundaryWebSHP/MP14_SUBZONE_WEB_PL.shp") %>% 
  st_make_valid()

# Saving CRS provided by SG boundary map
sg_crs <- st_crs(sg_ura_boundaries)

# Loading cleaned obesity data from HPB and giving spatial awareness
obesity_data <- 
  # "#N/A" values converted to "NA" for R to be able to read it
  read.csv("obesity.csv", na.strings = "#N/A") %>% 
  select(-PT_ID.1) %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  st_transform(crs = sg_crs) %>% 
  st_make_valid()

# Loading cleaned HMSP data from HPB and giving spatial awareness
hmsp_data_sf <- 
  read.csv("hmsp_tier_pri_sec.csv") %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  st_transform(crs = sg_crs) %>% 
  st_make_valid()

# Checking that all CRS are matching
isTRUE(all.equal(st_crs(sg_ura_boundaries), st_crs(obesity_data), st_crs(hmsp_data_sf)))

# Checking CRS units
st_crs(sg_ura_boundaries)$units
st_crs(obesity_data)$units
st_crs(hmsp_data_sf)$units
```

## Joining with relevant datasets

```{r}
# Loading General Information of Schools dataset
school_info <- 
  read_excel("Generalinformationofschools.xlsx", na = c("na", "NA")) %>% 
  # dropped variables are repeated in other data frames or not useful for our analysis
  select(school_name, dgp_code:mothertongue3_code, -zone_code, -mainlevel_code) 

obesity_data <- obesity_data %>% 
  left_join(school_info, by = join_by(SCHOOL == school_name))

# Loading previous year enrolment data
school_enrolment <-
  read_excel("enrolment.xlsx", sheet = "primary") %>% 
  select(-starts_with("intake"), -ENROLMENT24) # drop enrolment24 as obesity_data contains 2024 enrolment data for the full set of schools
```

## Transforming data to be usable for analysis

```{r}
# Changing "PRIMARY + SECONDARY" level label to match PRI and SEC classification
obesity_data <- obesity_data %>% mutate(
  LEVEL = case_when(
    LEVEL == "PRIMARY + SECONDARY" & PRI == 1 ~ "PRIMARY",
    LEVEL == "PRIMARY + SECONDARY" & PRI == 0 ~ "SECONDARY",
    TRUE ~ LEVEL
    )
  ) %>% select(-c("PRI", "SEC"))

# Convert school_enrolment from wide to long format
school_enrolment_long <- obesity_data %>% 
  rename(ENROLMENT24 = ENROLMENT) %>% 
  select(PT_ID, SCHOOL, ENROLMENT24) %>% 
  st_drop_geometry() %>% 
  # join 2024 enrollment data from obesity_data with school_enrolment data
  left_join(school_enrolment, by = join_by(PT_ID)) %>% 
  select(-SCHOOL.y) %>% 
  rename(SCHOOL = SCHOOL.x) %>% 
  pivot_longer(
    cols = starts_with("ENROLMENT"), 
    names_to = "YEAR", 
    values_to = "ENROLMENT"
    ) %>%
  # Extract year as numeric
  mutate(YEAR = as.numeric(gsub("ENROLMENT", "", YEAR)) + 2000) %>% 
  group_by(PT_ID) %>% 
  arrange(YEAR, .by_group = T)

# For schools where enrolment data is only available for 2024, replace the NA value in 2023 with the 2024 value. (This is done as most of our spatial analysis is done for the 2023 obesity prevalence data)
for (i in 1:nrow(school_enrolment_long)) {
  if (school_enrolment_long[i,3] == 2023 & is.na(school_enrolment_long[i,4])) {
    school_enrolment_long[i,4] = school_enrolment_long[i+1,4]
    }
  }

# Convert obesity_data from wide to long format
obesity_data_long <- obesity_data %>%
  pivot_longer(cols = starts_with("X"), 
               names_to = "YEAR_CATEGORY", 
               values_to = "COUNT") %>%
  separate(YEAR_CATEGORY, into = c("YEAR", "CATEGORY"), sep = "_", extra = "merge") %>%
  # Extract year as numeric
  mutate(YEAR = as.numeric(gsub("X", "", YEAR))) 

# Transform obesity count and school enrolment into an obesity prevalence figure
obesity_data_sf <- obesity_data_long %>%
  select(-ENROLMENT) %>% 
  full_join(school_enrolment_long, by = c("PT_ID", "SCHOOL", "YEAR")) %>%
  # Calculate overweight prevalence rate
  mutate(PREVALENCE = COUNT / ENROLMENT)  
```

We filter our data for the most recent year as the enrolment data given is for 2024. We focus on the number of students categorised as Overweight or Severely Overweight (OSO), in the most recent year 2023.

We remove "FUCHUN SECONDARY SCHOOL" as the enrolment data may be inaccurate due to school mergers. For our analysis for 2023, we remove "TANGLIN SECONDARY SCHOOL" and "GUANGYANG PRIMARY SCHOOL" as these schools have merged and no longer have overweight counts. We remove all remaining schools with no recorded data in 2023 (only "TANJONG KATONG GIRLS' SCHOOL")

```{r}
# for now, filter for 2023 data and overweight and severely overweight
obesity_data_sf_2023_OSO <- obesity_data_sf %>% 
  filter(
    YEAR == 2023, CATEGORY == "OSO", 
    !(SCHOOL %in% 
        c("FUCHUN SECONDARY SCHOOL", "TANGLIN SECONDARY SCHOOL","GUANGYANG PRIMARY SCHOOL")
      ),
    !is.na(PREVALENCE)
    )

#Combining prof's data with ours (delete this line pls)
oso23 = read_csv("Prof's Codes/oso23.csv", show_col_types = FALSE)
oso23 = oso23 |> drop_na(OSO_pct) 

# Re-classify
oso23[,c(3, 4, 8, 13:26)] = lapply(oso23[,c(3, 4, 8, 13:26)], as.factor)
oso23_new = oso23 %>% select(c("PT_ID", "HMSP_Tier", "HMSP_Score", "special"))
obesity_data_sf_2023_OSO_new = left_join(obesity_data_sf_2023_OSO, oso23_new, by = "PT_ID")
obesity_data_sf_2023_OSO = obesity_data_sf_2023_OSO_new #we can delete this line if necessary and just use obesity_data_sf_2023_oso_new
```

# Exploratory data analysis (by Prof)

```{r}
tmap_mode("plot")
tm_shape(sg_ura_boundaries) + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.4, fill = "TIER", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "HMSP Tiers"))

tm_shape(sg_ura_boundaries) + tm_fill() + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.4, fill = "ZONE", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "School zones"))

tm_shape(sg_ura_boundaries) + tm_fill() + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.3, fill = "CLUSTER", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "School clusters")) +
  tm_facets_wrap(by = "ZONE")

# OSO rate by school level
ggplot(obesity_data_sf_2023_OSO, aes(x = LEVEL, y = PREVALENCE, fill = LEVEL)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by School Level",
       x = "Level",
       y = "Prevalence Rate") +
  theme_minimal() +
  coord_flip()  # Flip the coordinates to make it horizontal 

# OSO rate by Zone
ggplot(obesity_data_sf_2023_OSO, aes(x = ZONE, y = PREVALENCE, fill = ZONE)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by Zone",
       x = "Zone",
       y = "Prevalence Rate") +
  theme_minimal() +
  coord_flip()  # Flip the coordinates to make it horizontal 

# OSO rate by School Type
sub = obesity_data_sf_2023_OSO |>
  filter(type_code %in% c("GOVERNMENT SCHOOL", "GOVERNMENT-AIDED SCH"))
ggplot(sub, aes(x = type_code, y = PREVALENCE, fill = type_code)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by School Type",
       x = "School Type",
       y = "Prevalence Rate") +
  theme_minimal() +
  coord_flip()  # Flip the coordinates to make it horizontal 

# OSO rate by Gender Mix
ggplot(obesity_data_sf_2023_OSO, aes(x = nature_code, y = PREVALENCE, fill = nature_code)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by Gender Mix",
       x = "Gender Mix",
       y = "Prevalence Rate") +
  theme_minimal() +
  scale_x_discrete(drop = TRUE) +
  coord_flip() # Flip the coordinates to make it horizontal 
  
# OSO rate by Specialised Programs
ggplot(obesity_data_sf_2023_OSO, aes(x = special, y = PREVALENCE, fill = special)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of prevalence rate by Specialised Programs",
       x = "Special Program",
       y = "Prevalence Rate") +
  theme_minimal() +
  scale_x_discrete(drop = TRUE) +
  coord_flip() # Flip the coordinates to make it horizontal 

# OSO rate by HMSP Tier
ggplot(obesity_data_sf_2023_OSO, aes(x = HMSP_Tier, y = PREVALENCE, fill = HMSP_Tier)) +
  geom_boxplot(na.rm = T) +
  labs(title = "Boxplot of OSO23 rate by HMSP Tier",
       x = "HMSP Tier",
       y = "OSO Rate") +
  theme_minimal() +
  scale_x_discrete(drop = TRUE) +
  coord_flip() # Flip the coordinates to make it horizontal 

cor(obesity_data_sf_2023_OSO$PREVALENCE, obesity_data_sf_2023_OSO$HMSP_Score)

```

```{r}

```


# Singapore maps

These are maps that define Singapore's regions based on URA defined boundaries (region, planning area, subzone) and MOE defined boundaries (zone, cluster). Subsequently, the defined regions can be used together with aggregated data so that we can examine overweight prevalence and other contributing factors by these differently delimited regions.

```{r}
tmap_mode("view")

# URA regions map
ura_regions <- sg_ura_boundaries %>% group_by(REGION_N) %>% 
  summarise(geometry = st_union(geometry))
ura_regions_map <- tm_shape(ura_regions, name = "URA regions") + tm_polygons(
    col = "grey", fill = "REGION_N", fill_alpha = 0.25, 
    fill.legend = tm_legend(title = "URA regions"))

# URA planning areas map
ura_planning_areas <- sg_ura_boundaries %>% group_by(PLN_AREA_N) %>% 
  summarise(geometry = st_union(geometry))
ura_planning_areas_map <- tm_shape(ura_planning_areas, name = "URA planning areas") + 
  tm_polygons(
    col = "grey", fill = "PLN_AREA_N", fill_alpha = 0.25, 
    fill.legend = tm_legend_hide())

# URA subzones map
ura_subzones <- sg_ura_boundaries %>% group_by(SUBZONE_N) %>% 
  summarise(geometry = st_union(geometry))
ura_subzones_map <- tm_shape(ura_subzones, name = "URA subzones") + tm_polygons(
  col = "grey", fill = "SUBZONE_N", fill_alpha = 0.25, 
  fill.legend = tm_legend_hide())

# MOE zones map
moe_zones <- obesity_data %>% group_by(ZONE) %>% 
  summarise(geometry = st_union(geometry)) %>% st_convex_hull()
moe_zone_map <- tm_shape(moe_zones, name = "MOE zones") + tm_polygons(
  col = "grey", fill = "ZONE", fill_alpha = 0.25, 
  fill.legend = tm_legend(title = "MOE School Zones"))

# MOE clusters map
moe_clusters <- obesity_data %>% group_by(CLUSTER) %>% 
  summarise(geometry = st_union(geometry)) %>% st_convex_hull()
moe_cluster_map <- tm_shape(moe_clusters, name = "MOE clusters") + tm_polygons(
  col = "grey", fill = "CLUSTER", fill_alpha = 0.25, 
  fill.legend = tm_legend_hide())
```

# Obesity profile in Singapore (Colin)

## Obesity prevalence overview map

The following map is an overview of overweight prevalence in Singapore schools. You may use the different layers provided in the map to view the individual school data against URA regions, planning areas and subzones, or MOE zones and clusters. Note that MOE zones and clusters have overlapping areas.

```{r}
tmap_mode("view")

# School obesity map plot
school_obesity_map <- tm_shape(obesity_data_sf_2023_OSO, name = "Overweight prevalence") +
  tm_symbols(
    size = 0.5,
    shape = "LEVEL",
    shape.legend = tm_legend(
      position = c("BOTTOM", "CENTER"),
      title = "Educational level"
      ),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

# Overview of overweight prevalence levels in Singapore schools
ura_regions_map + ura_planning_areas_map + ura_subzones_map + 
  moe_zone_map + moe_cluster_map +
  school_obesity_map +
  tm_title("Overview of overweight prevalence in Singapore schools")
```

## Obesity prevalence by educational level

We examine overweight prevalence in Singapore schools by educational level: Primary school or Secondary school. Primary school and secondary school students have different characteristics that might affect overweight prevalence.

The spatial mean centre (unweighted) and spatial variance (using the standard deviation distance and standard deviation ellipse) are calculated and plotted for each educational level.

### by Primary School

```{r}
tmap_mode("view")

# filter out by educational level and remove NA values to calculate SDE
obesity_pri_sch <- obesity_data_sf_2023_OSO %>% 
  filter(LEVEL == "PRIMARY", !is.na(PREVALENCE))

obesity_data_sf_2023_OSO %>% summary()

# Mean centre, standard deviation distance, standard deviation ellipse
pri_sch_mean <- calc_mnc(id = 1, points = st_coordinates(obesity_pri_sch))
pri_sch_median <- calc_mdc(id = 2, points = st_coordinates(obesity_pri_sch))
pri_sch_mean_median <- rbind(pri_sch_mean$LOCATIONS, pri_sch_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
pri_sch_mean_median$id = c("Spatial mean", "Spatial median")

pri_sch_sdd <- calc_sdd(id = 3, points = st_coordinates(obesity_pri_sch))
pri_sch_sdd_line <- pri_sch_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_sde <- calc_sde(id = 4, points = st_coordinates(obesity_pri_sch))
pri_sch_sde_line <- pri_sch_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = obesity_pri_sch$PREVALENCE,
  points = st_coordinates(obesity_pri_sch))
pri_sch_sde_weighted_line <- pri_sch_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_map <- ura_regions_map +
  tm_shape(obesity_pri_sch, name = "Overweight prevalence") +
  tm_symbols(
    size = "PREVALENCE",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

pri_sch_map +
  tm_shape(pri_sch_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(pri_sch_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(pri_sch_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(pri_sch_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Overweight prevalence in Primary Schools")
```

### by Secondary School

```{r}
tmap_mode("view")

# filter out by educational level and remove NA values to calculate SDE
obesity_sec_sch <- obesity_data_sf_2023_OSO %>% 
  filter(LEVEL == "SECONDARY", !is.na(PREVALENCE))

# Mean centre, standard deviation distance, standard deviation ellipse
sec_sch_mean <- calc_mnc(id = 1, points = st_coordinates(obesity_sec_sch))
sec_sch_median <- calc_mdc(id = 2, points = st_coordinates(obesity_sec_sch))
sec_sch_mean_median <- rbind(sec_sch_mean$LOCATIONS, sec_sch_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
sec_sch_mean_median$id = c("Spatial mean", "Spatial median")

sec_sch_sdd <- calc_sdd(id = 3, points = st_coordinates(obesity_sec_sch))
sec_sch_sdd_line <- sec_sch_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_sde <- calc_sde(id = 4, points = st_coordinates(obesity_sec_sch))
sec_sch_sde_line <- sec_sch_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = obesity_sec_sch$PREVALENCE,
  points = st_coordinates(obesity_sec_sch))
sec_sch_sde_weighted_line <- sec_sch_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_map <- ura_regions_map +
  tm_shape(obesity_sec_sch, name = "Overweight prevalence") +
  tm_symbols(
    shape = 22,
    size = "PREVALENCE",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

sec_sch_map +
  tm_shape(sec_sch_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(sec_sch_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(sec_sch_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(sec_sch_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Overweight prevalence in Secondary Schools")

# tmap_arrange(pri_sch_map, sec_sch_map, nrow = 1)
```

Generally, we observe greater overweight prevalence levels for schools in the North and lower overweight prevalence levels in the South and Central regions of Singapore.

## Obesity prevalence by region

We aggregate overweight counts and school enrolment data by the different delimited regions, and fill in the regions to get visualise overweight prevalence by region.

```{r}
# Aggregating overweight counts by URA regions
obesity_ura_regions <- st_join(ura_regions, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(REGION_N, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_regions_map + obesity_ura_regions %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    # fill.scale = tm_scale_continuous(values = "brewer.yl_or_rd"), 
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      # orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA regions") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by URA planning areas
obesity_ura_planning_areas <- st_join(ura_planning_areas, obesity_data_sf) %>%
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(PLN_AREA_N, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_planning_areas_map + obesity_ura_planning_areas %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA planning areas") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by URA subzones
obesity_ura_subzones <- st_join(ura_subzones, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(SUBZONE_N, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_subzones_map + obesity_ura_subzones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA subzones") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by MOE school zones
obesity_moe_zones <- 
  # we left_join instead of st_join due to overlapping boundaries
  left_join(moe_zones, st_drop_geometry(obesity_data_sf)) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(ZONE, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

moe_zone_map +
  tm_legend_hide() + 
  obesity_moe_zones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill_alpha = 0.95,
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1,
      show = T
      )
    ) +
  tm_title("Overweight prevalence by MOE clusters") +
  tm_facets_wrap(by = "LEVEL")

# Aggregating overweight counts by MOE clusters
obesity_moe_clusters <- 
  left_join(moe_clusters, st_drop_geometry(obesity_data_sf)) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(CLUSTER, LEVEL) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

moe_cluster_map + obesity_moe_clusters %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill_alpha = 0.95,
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "brewer.yl_or_rd"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1,
      show = T
      )
    ) +
  tm_title("Overweight prevalence by MOE clusters") +
  tm_facets_wrap(by = "LEVEL")
```

## Spatial clustering of obesity
To consider spatial clustering of obesity in schools, we need to define how schools are connect spatially (what are each schools' neighbours). We analysed spatial autocorrelation in administrative regions (URA regions, planning areas, subzones, MOE clusters), graph neighbours (Delauney triangulation, Sphere of influence), and nearest neighbours (nearest 1, 2 and 3). We determined that spatial clustering is best observed under Delauney triangulation.

# Region based analysis (Contiguous neighbouring regions)

There are too few contiguous neighbours by URA region to analyse meaningfully (only 5 URA regions). When analysing by URA subzone, there are too many non-contiguous subzones. We recommend to only analyse by URA planning area, which has some non-contiguous neighbours in the central regions. These non-contiguous neighbours by planning area are then manually edited (in the .gal file) to create neighbours with nearest planning areas to ensure contiguity for spatial statistical tests.

## Contiguous neighbours by URA regions

```{r}
# by Primary school
obesity_ura_regions_pri <- obesity_ura_regions %>% filter(LEVEL == "PRIMARY")
ura_regions_nb_pri <- obesity_ura_regions_pri %>% poly2nb(queen = T)
ura_regions_nb_line_pri <- ura_regions_nb_pri %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_regions_pri)))
pri_map <- ura_regions_map +
  ura_regions_nb_line_pri %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_regions_pri)) %>% tm_shape() + tm_symbols()

# by Secondary school
obesity_ura_regions_sec <- obesity_ura_regions %>% filter(LEVEL == "SECONDARY")
ura_regions_nb_sec <- obesity_ura_regions_sec %>% poly2nb(queen = T)
ura_regions_nb_line_sec <- ura_regions_nb_sec %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_regions_sec)))
sec_map <- ura_regions_map +
  ura_regions_nb_line_sec %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_regions_sec)) %>% tm_shape() + tm_symbols()

tmap_arrange(pri_map, sec_map)
```

## Contiguous neighbours by URA planning areas

```{r}
# by Primary school
obesity_ura_planning_areas_pri <- obesity_ura_planning_areas %>%
  filter(LEVEL == "PRIMARY") %>%
  rowid_to_column("index")

# # Manually connecting 1 observation with no neighbours with its nearest neighbours
# ura_planning_areas_nb_pri <- obesity_ura_planning_areas_pri %>% poly2nb(queen = T)
# ura_planning_areas_nb_pri %>%
#   write.nb.gal(file = "ura_planning_areas_nb_pri.gal",
#                ind = ura_planning_areas_nb_pri$index)

ura_planning_areas_nb_pri <- read.gal("ura_planning_areas_nb_pri.gal")
ura_planning_areas_nb_line_pri <- ura_planning_areas_nb_pri %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_planning_areas_pri)))
pri_map <- ura_planning_areas_map +
  ura_planning_areas_nb_line_pri %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_planning_areas_pri)) %>% 
  tm_shape() + tm_symbols()

# by Secondary school
obesity_ura_planning_areas_sec <- obesity_ura_planning_areas %>% 
  filter(LEVEL == "SECONDARY")  %>%
  rowid_to_column("index")

# # Manually connecting 1 observation with no neighbours with its nearest neighbour
# ura_planning_areas_nb_sec <- obesity_ura_planning_areas_sec %>% poly2nb(queen = T)
# ura_planning_areas_nb_sec %>%
#   write.nb.gal(file = "ura_planning_areas_nb_sec.gal",
#                ind = ura_planning_areas_nb_sec$index)

ura_planning_areas_nb_sec <- read.gal("ura_planning_areas_nb_sec.gal")
ura_planning_areas_nb_line_sec <- ura_planning_areas_nb_sec %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_planning_areas_sec)))
sec_map <- ura_planning_areas_map +
  ura_planning_areas_nb_line_sec %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_planning_areas_sec)) %>% 
  tm_shape() + tm_symbols()

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(ura_planning_areas_lw_pri <- nb2listw(ura_planning_areas_nb_pri, style = "W"))
ura_planning_areas_lw_B_pri <- nb2listw(ura_planning_areas_nb_pri, style = "B")
moran.test(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, ura_planning_areas_lw_pri)
moran.plot(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, ura_planning_areas_lw_pri,
           main="Moran scatterplot")
geary.test(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, ura_planning_areas_lw_pri)
globalG.test(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE,
             ura_planning_areas_lw_B_pri)

# by Secondary schools
(ura_planning_areas_lw_sec <- nb2listw(ura_planning_areas_nb_sec, style = "W"))
ura_planning_areas_lw_B_sec <- nb2listw(ura_planning_areas_nb_sec, style = "B")
moran.test(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, ura_planning_areas_lw_sec)
moran.plot(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, ura_planning_areas_lw_sec, 
           main="Moran scatterplot")
geary.test(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, ura_planning_areas_lw_sec)
globalG.test(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE,
             ura_planning_areas_lw_B_sec)
```

Average number of links (Primary school): 3.428571 
p-value for Global Moran's I test (Primary school): 0.005857
p-value for Global Geary's C test (Primary school): 0.005738
p-value for Global Getis-Ord's G test (Primary school): 0.8278

Average number of links (Secondary school): 3.285714 
p-value for Global Moran's I test (Secondary school): 0.5256
p-value for Global Geary's C test (Secondary school): 0.5418
p-value for Global Getis-Ord's G test (Secondary school): 0.8072

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_ura_planning_areas_pri$HIGH_PREVALENCE <- 
  as.factor(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_ura_planning_areas_pri %>% 
  tm_shape(name = "Overweight prevalence") + tm_polygons(fill = "HIGH_PREVALENCE") +
  tm_title("Join count analysis")
joincount.multi(obesity_ura_planning_areas_pri$HIGH_PREVALENCE, 
                ura_planning_areas_lw_B_pri) 

# by Secondary school
obesity_ura_planning_areas_sec$HIGH_PREVALENCE <- 
  as.factor(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_ura_planning_areas_sec %>% 
  tm_shape(name = "Overweight prevalence") + tm_polygons(fill = "HIGH_PREVALENCE") +
  tm_title("Join count analysis")
joincount.multi(obesity_ura_planning_areas_sec$HIGH_PREVALENCE, 
                ura_planning_areas_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_ura_planning_areas_pri <- 
  localmoran(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
             ura_planning_areas_lw_pri)
obesity_ura_planning_areas_pri$LMORANZ <- localm_ura_planning_areas_pri[,4]
pri_map <- tm_shape(obesity_ura_planning_areas_pri) + tm_polygons(fill = "LMORANZ") + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_ura_planning_areas_sec <- 
  localmoran(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
             ura_planning_areas_lw_sec)
obesity_ura_planning_areas_sec$LMORANZ <- localm_ura_planning_areas_sec[,4]
sec_map <- tm_shape(obesity_ura_planning_areas_sec) + tm_polygons(fill = "LMORANZ") + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_ura_planning_areas_pri$GO_STAT <-
  localG(obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
         ura_planning_areas_lw_B_pri)
pri_map <- tm_shape(obesity_ura_planning_areas_pri) + tm_polygons("GO_STAT") +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_ura_planning_areas_sec$GO_STAT <-
  localG(obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
         ura_planning_areas_lw_B_sec)
sec_map <- tm_shape(obesity_ura_planning_areas_sec) + tm_polygons("GO_STAT") +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram
```{r}
# by Primary school
correl_planning_areas_pri <- sp.correlogram(
  ura_planning_areas_nb_pri, obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
  order = 3, method = "corr", style = "W")
correlI_planning_areas_pri <- sp.correlogram(
  ura_planning_areas_nb_pri, obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE, 
  order = 3, method = "I", style = "W")
correlC_planning_areas_pri <- sp.correlogram(
  ura_planning_areas_nb_pri, obesity_ura_planning_areas_pri$PREVALENCE_AGGREGATE,
  order = 3, method = "C", style = "W")
par(mfrow=c(2,3))
plot(correl_planning_areas_pri, main="Contiguity lag orders: correlation")
plot(correlI_planning_areas_pri, main="Contiguity lag orders: Moran's I")
plot(correlC_planning_areas_pri, main="Contiguity lag orders: Geary's C")

# by Secondary school
correl_planning_areas_sec <- sp.correlogram(
  ura_planning_areas_nb_sec, obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
  order = 3, method = "corr", style = "W")
correlI_planning_areas_sec <- sp.correlogram(
  ura_planning_areas_nb_sec, obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE, 
  order = 3, method = "I", style = "W")
correlC_planning_areas_sec <- sp.correlogram(
  ura_planning_areas_nb_sec, obesity_ura_planning_areas_sec$PREVALENCE_AGGREGATE,
  order = 3, method = "C", style = "W")
plot(correl_planning_areas_sec, main="Contiguity lag orders: correlation")
plot(correlI_planning_areas_sec, main="Contiguity lag orders: Moran's I")
plot(correlC_planning_areas_sec, main="Contiguity lag orders: Geary's C")
par(mfrow=c(1,1))
```

## Contiguous neighbours by URA subzones

```{r}
obesity_ura_subzones_pri <- obesity_ura_subzones %>% filter(LEVEL == "PRIMARY")
ura_subzones_nb_pri <- obesity_ura_subzones_pri %>% poly2nb(queen = T)
ura_subzones_nb_line_pri <- ura_subzones_nb_pri %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_subzones_pri)))
pri_map <- ura_subzones_map +
  ura_subzones_nb_line_pri %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_subzones_pri)) %>% tm_shape() + tm_symbols()

obesity_ura_subzones_sec <- obesity_ura_subzones %>% filter(LEVEL == "SECONDARY")
ura_subzones_nb_sec <- obesity_ura_subzones_sec %>% poly2nb(queen = T)
ura_subzones_nb_line_sec <- ura_subzones_nb_sec %>% 
  nb2lines(coords = st_point_on_surface(st_geometry(obesity_ura_subzones_sec)))
sec_map <- ura_subzones_map +
  ura_subzones_nb_line_sec %>% tm_shape() + tm_lines(lwd = 2) + 
  st_point_on_surface(st_geometry(obesity_ura_subzones_sec)) %>% tm_shape() + tm_symbols()

tmap_arrange(pri_map, sec_map)
```

# Cluster based analysis (Social distance)

## MOE clusters

```{r}
# # Function to write a .gal file in the specified format
# write_gal <- function(data, filename) {
#   fileConn <- file(filename, "w")
#   # Write the number of participants
#   writeLines(as.character(nrow(data)), fileConn)
#   # Iterate through each participant
#   for (i in seq_len(nrow(data))) {
#     pt_id <- data$PT_ID[i]
#     # Find neighbors (same CLUSTER, different PT_ID)
#     neighbors <- data$PT_ID[data$CLUSTER == data$CLUSTER[i] & data$PT_ID != pt_id]
#     # Write PT_ID followed by number of neighbors
#     writeLines(paste(as.character(pt_id), length(neighbors)) , fileConn)
#     # Write list of neighbors (if any)
#     if (length(neighbors) > 0) {
#       writeLines(paste(neighbors, collapse = " "), fileConn)
#     }
#   }
#   close(fileConn)
# }
# 
# # Write to a .gal file
# moe_clusters_pri <- obesity_pri_sch %>%
#   st_drop_geometry() %>%
#   select(PT_ID, SCHOOL, CLUSTER)
# write_gal(moe_clusters_pri, "moe_clusters_pri.gal")
# 
# moe_clusters_sec <- obesity_sec_sch %>%
#   st_drop_geometry() %>%
#   select(PT_ID, SCHOOL, CLUSTER)
# write_gal(moe_clusters_sec, "moe_clusters_sec.gal")

moe_clusters_nb_pri <- read.gal("moe_clusters_pri.gal", region.id = obesity_pri_sch$PT_ID)
moe_clusters_nb_sec <- read.gal("moe_clusters_sec.gal", region.id = obesity_sec_sch$PT_ID)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(moe_clusters_lw_pri <- nb2listw(moe_clusters_nb_pri, style = "W"))
moe_clusters_lw_B_pri <- nb2listw(moe_clusters_nb_pri, style = "B")
moran.test(obesity_pri_sch$PREVALENCE, moe_clusters_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, moe_clusters_lw_pri, main="Moran scatterplot")
geary.test(obesity_pri_sch$PREVALENCE, moe_clusters_lw_pri)
globalG.test(obesity_pri_sch$PREVALENCE, moe_clusters_lw_B_pri)

# by Secondary schools
(moe_clusters_lw_sec <- nb2listw(moe_clusters_nb_sec, style = "W"))
moe_clusters_lw_B_sec <- nb2listw(moe_clusters_nb_sec, style = "B")
moran.test(obesity_sec_sch$PREVALENCE, moe_clusters_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, moe_clusters_lw_sec, main="Moran scatterplot")
geary.test(obesity_sec_sch$PREVALENCE, moe_clusters_lw_sec)
globalG.test(obesity_sec_sch$PREVALENCE, moe_clusters_lw_B_sec)
```

Average number of links (Primary school): 5.657459 
p-value for Global Moran's I test (Primary school): 0.1608
p-value for Global Geary's C test (Primary school): 0.1608
p-value for Global Getis-Ord's G test (Primary school): 0.02355

Average number of links (Secondary school): 4.347222 
p-value for Global Moran's I test (Secondary school): 0.1768
p-value for Global Geary's C test (Secondary school): 0.1768
p-value for Global Getis-Ord's G test (Secondary school): 0.8314

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_pri_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_pri_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_pri_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_pri_sch$HIGH_PREVALENCE, 
                moe_clusters_lw_B_pri) 

# by Secondary school
obesity_sec_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_sec_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_sec_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_sec_sch$HIGH_PREVALENCE, 
                moe_clusters_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_moe_clusters_pri <- 
  localmoran(obesity_pri_sch$PREVALENCE, 
             moe_clusters_lw_pri)
obesity_pri_sch$LMORANZ <- localm_moe_clusters_pri[,4]
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_moe_clusters_sec <- 
  localmoran(obesity_sec_sch$PREVALENCE, 
             moe_clusters_lw_sec)
obesity_sec_sch$LMORANZ <- localm_moe_clusters_sec[,4]
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_pri_sch$GO_STAT <-
  localG(obesity_pri_sch$PREVALENCE, 
         moe_clusters_lw_B_pri)
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_sec_sch$GO_STAT <-
  localG(obesity_sec_sch$PREVALENCE, 
         moe_clusters_lw_B_sec)
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram (does not work)
```{r}
# # by Primary school
# correl_moe_clusters_pri <- sp.correlogram(
#   moe_clusters_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_moe_clusters_pri <- sp.correlogram(
#   moe_clusters_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_moe_clusters_pri <- sp.correlogram(
#   moe_clusters_nb_pri, obesity_pri_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(2,3))
# plot(correl_moe_clusters_pri, main="Contiguity lag orders: correlation")
# plot(correlI_moe_clusters_pri, main="Contiguity lag orders: Moran's I")
# plot(correlC_moe_clusters_pri, main="Contiguity lag orders: Geary's C")
# 
# # by Secondary school
# correl_moe_clusters_sec <- sp.correlogram(
#   moe_clusters_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_moe_clusters_sec <- sp.correlogram(
#   moe_clusters_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_moe_clusters_sec <- sp.correlogram(
#   moe_clusters_nb_sec, obesity_sec_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# plot(correl_moe_clusters_sec, main="Contiguity lag orders: correlation")
# plot(correlI_moe_clusters_sec, main="Contiguity lag orders: Moran's I")
# plot(correlC_moe_clusters_sec, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))
```

# Graph neighbours based analysis

## Delauney triangulation neighbours

```{r}
# by Primary schools
# obesity_pri_sch_jitter <- st_jitter(obesity_pri_sch) 
del_nb_pri <- tri2nb(st_coordinates(obesity_pri_sch), 
                     row.names = obesity_pri_sch$PT_ID) 
pri_map <- tm_shape(nb2lines(del_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
# obesity_sec_sch_jitter <- st_jitter(obesity_sec_sch) 
del_nb_sec <- tri2nb(st_coordinates(obesity_sec_sch), 
                     row.names = obesity_sec_sch$PT_ID) 
sec_map <- tm_shape(nb2lines(del_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(del_lw_pri <- nb2listw(del_nb_pri, style = "W"))
del_lw_B_pri <- nb2listw(del_nb_pri, style = "B")
moran.test(obesity_pri_sch$PREVALENCE, del_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, del_lw_pri, main="Moran scatterplot")
geary.test(obesity_pri_sch$PREVALENCE, del_lw_pri)
globalG.test(obesity_pri_sch$PREVALENCE, del_lw_B_pri)

# by Secondary schools
(del_lw_sec <- nb2listw(del_nb_sec, style = "W"))
del_lw_B_sec <- nb2listw(del_nb_sec, style = "B")
moran.test(obesity_sec_sch$PREVALENCE, del_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, del_lw_sec, main="Moran scatterplot")
geary.test(obesity_sec_sch$PREVALENCE, del_lw_sec)
globalG.test(obesity_sec_sch$PREVALENCE, del_lw_B_sec)
```

Average number of links (Primary school): 5.823204 
p-value for Global Moran's I test (Primary school): 1.809e-12
p-value for Global Geary's C test (Primary school): 3.885e-12
p-value for Global Getis-Ord's G test (Primary school): 0.03254

Average number of links (Secondary school): 5.805556 
p-value for Global Moran's I test (Secondary school): 0.0001695
p-value for Global Geary's C test (Secondary school): 9.452e-05
p-value for Global Getis-Ord's G test (Secondary school): 0.2914

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_pri_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_pri_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_pri_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_pri_sch$HIGH_PREVALENCE, 
                del_lw_B_pri) 

# by Secondary school
obesity_sec_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_sec_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_sec_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_sec_sch$HIGH_PREVALENCE, 
                del_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_del_pri <- 
  localmoran(obesity_pri_sch$PREVALENCE, 
             del_lw_pri)
obesity_pri_sch$LMORANZ <- localm_del_pri[,4]
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_del_sec <- 
  localmoran(obesity_sec_sch$PREVALENCE, 
             del_lw_sec)
obesity_sec_sch$LMORANZ <- localm_del_sec[,4]
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_pri_sch$GO_STAT <-
  localG(obesity_pri_sch$PREVALENCE, 
         del_lw_B_pri)
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_sec_sch$GO_STAT <-
  localG(obesity_sec_sch$PREVALENCE, 
         del_lw_B_sec)
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram
```{r}
# by Primary school
correl_del_pri <- sp.correlogram(
  del_nb_pri, obesity_pri_sch$PREVALENCE, 
  order = 3, method = "corr", style = "W")
correlI_del_pri <- sp.correlogram(
  del_nb_pri, obesity_pri_sch$PREVALENCE, 
  order = 3, method = "I", style = "W")
correlC_del_pri <- sp.correlogram(
  del_nb_pri, obesity_pri_sch$PREVALENCE,
  order = 3, method = "C", style = "W")
par(mfrow=c(2,3))
plot(correl_del_pri, main="Contiguity lag orders: correlation")
plot(correlI_del_pri, main="Contiguity lag orders: Moran's I")
plot(correlC_del_pri, main="Contiguity lag orders: Geary's C")

# by Secondary school
correl_del_sec <- sp.correlogram(
  del_nb_sec, obesity_sec_sch$PREVALENCE, 
  order = 3, method = "corr", style = "W")
correlI_del_sec <- sp.correlogram(
  del_nb_sec, obesity_sec_sch$PREVALENCE, 
  order = 3, method = "I", style = "W")
correlC_del_sec <- sp.correlogram(
  del_nb_sec, obesity_sec_sch$PREVALENCE,
  order = 3, method = "C", style = "W")
plot(correl_del_sec, main="Contiguity lag orders: correlation")
plot(correlI_del_sec, main="Contiguity lag orders: Moran's I")
plot(correlC_del_sec, main="Contiguity lag orders: Geary's C")
par(mfrow=c(1,1))
```


## Sphere of influence neighbours

```{r}
# by Primary schools
if (require(dbscan, quietly=TRUE)) {
  soi_nb_pri <- graph2nb(soi.graph(del_nb_pri, st_geometry(obesity_pri_sch)))
} else {
  soi_nb = NULL
}
pri_map <- tm_shape(nb2lines(soi_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
if (require(dbscan, quietly=TRUE)) {
  soi_nb_sec <- graph2nb(soi.graph(del_nb_sec, st_geometry(obesity_sec_sch)))
} else {
  soi_nb = NULL
}
sec_map <- tm_shape(nb2lines(soi_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(soi_lw_pri <- nb2listw(soi_nb_pri, style = "W"))
soi_lw_B_pri <- nb2listw(soi_nb_pri, style = "B")
moran.test(obesity_pri_sch$PREVALENCE, soi_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, soi_lw_pri, main="Moran scatterplot")
geary.test(obesity_pri_sch$PREVALENCE, soi_lw_pri)
globalG.test(obesity_pri_sch$PREVALENCE, soi_lw_B_pri)

# by Secondary schools
(soi_lw_sec <- nb2listw(soi_nb_sec, style = "W"))
soi_lw_B_sec <- nb2listw(soi_nb_sec, style = "B")
moran.test(obesity_sec_sch$PREVALENCE, soi_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, soi_lw_sec, main="Moran scatterplot")
geary.test(obesity_sec_sch$PREVALENCE, soi_lw_sec)
globalG.test(obesity_sec_sch$PREVALENCE, soi_lw_B_sec)
```

Average number of links (Primary school): 3.082873 
p-value for Global Moran's I test (Primary school): 6.672e-07
p-value for Global Geary's C test (Primary school): 3.173e-07
p-value for Global Getis-Ord's G test (Primary school): 0.07193

Average number of links (Secondary school): 2.958333 
p-value for Global Moran's I test (Secondary school): 0.0004617
p-value for Global Geary's C test (Secondary school): 0.0002675
p-value for Global Getis-Ord's G test (Secondary school): 0.3102

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_pri_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_pri_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_pri_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_pri_sch$HIGH_PREVALENCE, 
                soi_lw_B_pri) 

# by Secondary school
obesity_sec_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_sec_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_sec_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_sec_sch$HIGH_PREVALENCE, 
                soi_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_soi_pri <- 
  localmoran(obesity_pri_sch$PREVALENCE, 
             soi_lw_pri)
obesity_pri_sch$LMORANZ <- localm_soi_pri[,4]
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_soi_sec <- 
  localmoran(obesity_sec_sch$PREVALENCE, 
             soi_lw_sec)
obesity_sec_sch$LMORANZ <- localm_soi_sec[,4]
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_pri_sch$GO_STAT <-
  localG(obesity_pri_sch$PREVALENCE, 
         soi_lw_B_pri)
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_sec_sch$GO_STAT <-
  localG(obesity_sec_sch$PREVALENCE, 
         soi_lw_B_sec)
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram (does not work)
Some sub-graphs have 2 or less neighbours
```{r}
# # by Primary school
# correl_soi_pri <- sp.correlogram(
#   soi_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_soi_pri <- sp.correlogram(
#   soi_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_soi_pri <- sp.correlogram(
#   soi_nb_pri, obesity_pri_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(2,3))
# plot(correl_soi_pri, main="Contiguity lag orders: correlation")
# plot(correlI_soi_pri, main="Contiguity lag orders: Moran's I")
# plot(correlC_soi_pri, main="Contiguity lag orders: Geary's C")
# 
# # by Secondary school
# correl_soi_sec <- sp.correlogram(
#   soi_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_soi_sec <- sp.correlogram(
#   soi_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_soi_sec <- sp.correlogram(
#   soi_nb_sec, obesity_sec_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# plot(correl_soi_sec, main="Contiguity lag orders: correlation")
# plot(correlI_soi_sec, main="Contiguity lag orders: Moran's I")
# plot(correlC_soi_sec, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))
```

# K nearest neighbour based analysis

## 1 neighbour
```{r}
# by Primary schools
knn1_nb_pri <- obesity_pri_sch %>% 
  knearneigh(k = 1) %>% 
  knn2nb(row.names = obesity_pri_sch$PT_ID) # nearest neighbour
pri_map <- tm_shape(nb2lines(knn1_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
knn1_nb_sec <- obesity_sec_sch %>% 
  knearneigh(k = 1) %>% 
  knn2nb(row.names = obesity_sec_sch$PT_ID) # nearest neighbour
sec_map <- tm_shape(nb2lines(knn1_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(knn1_lw_pri <- nb2listw(knn1_nb_pri, style = "W"))
knn1_lw_B_pri <- nb2listw(knn1_nb_pri, style = "B")
moran.test(obesity_pri_sch$PREVALENCE, knn1_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, knn1_lw_pri, main="Moran scatterplot")
geary.test(obesity_pri_sch$PREVALENCE, knn1_lw_pri)
globalG.test(obesity_pri_sch$PREVALENCE, knn1_lw_B_pri)

# by Secondary schools
(knn1_lw_sec <- nb2listw(knn1_nb_sec, style = "W"))
knn1_lw_B_sec <- nb2listw(knn1_nb_sec, style = "B")
moran.test(obesity_sec_sch$PREVALENCE, knn1_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, knn1_lw_sec, main="Moran scatterplot")
geary.test(obesity_sec_sch$PREVALENCE, knn1_lw_sec)
globalG.test(obesity_sec_sch$PREVALENCE, knn1_lw_B_sec)
```

Average number of links (Primary school): 1 
p-value for Global Moran's I test (Primary school): 0.004193
p-value for Global Geary's C test (Primary school): 0.02331
p-value for Global Getis-Ord's G test (Primary school): 0.09593

Average number of links (Secondary school): 1 
p-value for Global Moran's I test (Secondary school): 0.0004819
p-value for Global Geary's C test (Secondary school): 0.004126
p-value for Global Getis-Ord's G test (Secondary school): 0.234

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_pri_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_pri_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_pri_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_pri_sch$HIGH_PREVALENCE, 
                knn1_lw_B_pri) 

# by Secondary school
obesity_sec_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_sec_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_sec_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_sec_sch$HIGH_PREVALENCE, 
                knn1_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_knn1_pri <- 
  localmoran(obesity_pri_sch$PREVALENCE, 
             knn1_lw_pri)
obesity_pri_sch$LMORANZ <- localm_knn1_pri[,4]
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_knn1_sec <- 
  localmoran(obesity_sec_sch$PREVALENCE, 
             knn1_lw_sec)
obesity_sec_sch$LMORANZ <- localm_knn1_sec[,4]
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_pri_sch$GO_STAT <-
  localG(obesity_pri_sch$PREVALENCE, 
         knn1_lw_B_pri)
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_sec_sch$GO_STAT <-
  localG(obesity_sec_sch$PREVALENCE, 
         knn1_lw_B_sec)
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram (does not work)
Some sub-graphs have 2 or less neighbours
```{r}
# # by Primary school
# correl_knn1_pri <- sp.correlogram(
#   knn1_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_knn1_pri <- sp.correlogram(
#   knn1_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_knn1_pri <- sp.correlogram(
#   knn1_nb_pri, obesity_pri_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(2,3))
# plot(correl_knn1_pri, main="Contiguity lag orders: correlation")
# plot(correlI_knn1_pri, main="Contiguity lag orders: Moran's I")
# plot(correlC_knn1_pri, main="Contiguity lag orders: Geary's C")
# 
# # by Secondary school
# correl_knn1_sec <- sp.correlogram(
#   knn1_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_knn1_sec <- sp.correlogram(
#   knn1_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_knn1_sec <- sp.correlogram(
#   knn1_nb_sec, obesity_sec_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# plot(correl_knn1_sec, main="Contiguity lag orders: correlation")
# plot(correlI_knn1_sec, main="Contiguity lag orders: Moran's I")
# plot(correlC_knn1_sec, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))
```

## 2 neighbours
```{r}
# by Primary schools
knn2_nb_pri <- obesity_pri_sch %>% 
  knearneigh(k = 2) %>% 
  knn2nb(row.names = obesity_pri_sch$PT_ID) # nearest neighbour
pri_map <- tm_shape(nb2lines(knn2_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
knn2_nb_sec <- obesity_sec_sch %>% 
  knearneigh(k = 2) %>% 
  knn2nb(row.names = obesity_sec_sch$PT_ID) # nearest neighbour
sec_map <- tm_shape(nb2lines(knn2_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(knn2_lw_pri <- nb2listw(knn2_nb_pri, style = "W"))
knn2_lw_B_pri <- nb2listw(knn2_nb_pri, style = "B")
moran.test(obesity_pri_sch$PREVALENCE, knn2_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, knn2_lw_pri, main="Moran scatterplot")
geary.test(obesity_pri_sch$PREVALENCE, knn2_lw_pri)
globalG.test(obesity_pri_sch$PREVALENCE, knn2_lw_B_pri)

# by Secondary schools
(knn2_lw_sec <- nb2listw(knn2_nb_sec, style = "W"))
knn2_lw_B_sec <- nb2listw(knn2_nb_sec, style = "B")
moran.test(obesity_sec_sch$PREVALENCE, knn2_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, knn2_lw_sec, main="Moran scatterplot")
geary.test(obesity_sec_sch$PREVALENCE, knn2_lw_sec)
globalG.test(obesity_sec_sch$PREVALENCE, knn2_lw_B_sec)
```

Average number of links (Primary school): 2
p-value for Global Moran's I test (Primary school): 1.474e-05
p-value for Global Geary's C test (Primary school): 4.17e-05
p-value for Global Getis-Ord's G test (Primary school): 0.01137

Average number of links (Secondary school): 2
p-value for Global Moran's I test (Secondary school): 0.003471
p-value for Global Geary's C test (Secondary school): 0.03461
p-value for Global Getis-Ord's G test (Secondary school): 0.2781

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_pri_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_pri_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_pri_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_pri_sch$HIGH_PREVALENCE, 
                knn2_lw_B_pri) 

# by Secondary school
obesity_sec_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_sec_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_sec_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_sec_sch$HIGH_PREVALENCE, 
                knn2_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_knn2_pri <- 
  localmoran(obesity_pri_sch$PREVALENCE, 
             knn2_lw_pri)
obesity_pri_sch$LMORANZ <- localm_knn2_pri[,4]
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_knn2_sec <- 
  localmoran(obesity_sec_sch$PREVALENCE, 
             knn2_lw_sec)
obesity_sec_sch$LMORANZ <- localm_knn2_sec[,4]
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_pri_sch$GO_STAT <-
  localG(obesity_pri_sch$PREVALENCE, 
         knn2_lw_B_pri)
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_sec_sch$GO_STAT <-
  localG(obesity_sec_sch$PREVALENCE, 
         knn2_lw_B_sec)
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram (does not work)
Some sub-graphs have 2 or less neighbours
```{r}
# # by Primary school
# correl_knn2_pri <- sp.correlogram(
#   knn2_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_knn2_pri <- sp.correlogram(
#   knn2_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_knn2_pri <- sp.correlogram(
#   knn2_nb_pri, obesity_pri_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(2,3))
# plot(correl_knn2_pri, main="Contiguity lag orders: correlation")
# plot(correlI_knn2_pri, main="Contiguity lag orders: Moran's I")
# plot(correlC_knn2_pri, main="Contiguity lag orders: Geary's C")
# 
# # by Secondary school
# correl_knn2_sec <- sp.correlogram(
#   knn2_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_knn2_sec <- sp.correlogram(
#   knn2_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_knn2_sec <- sp.correlogram(
#   knn2_nb_sec, obesity_sec_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# plot(correl_knn2_sec, main="Contiguity lag orders: correlation")
# plot(correlI_knn2_sec, main="Contiguity lag orders: Moran's I")
# plot(correlC_knn2_sec, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))
```

## 3 neighbours
```{r}
# by Primary schools
knn3_nb_pri <- obesity_pri_sch %>% 
  knearneigh(k = 3) %>% 
  knn2nb(row.names = obesity_pri_sch$PT_ID) # nearest neighbour
pri_map <- tm_shape(nb2lines(knn3_nb_pri, coords = st_geometry(obesity_pri_sch))) +
  tm_lines(lwd = 2) + pri_sch_map

# by Secondary schools
knn3_nb_sec <- obesity_sec_sch %>% 
  knearneigh(k = 3) %>% 
  knn2nb(row.names = obesity_sec_sch$PT_ID) # nearest neighbour
sec_map <- tm_shape(nb2lines(knn3_nb_sec, coords = st_geometry(obesity_sec_sch))) +
  tm_lines(lwd = 2) + sec_sch_map

tmap_arrange(pri_map, sec_map)
```

### Spatial autocorrelation statistics

```{r}
# by Primary schools
(knn3_lw_pri <- nb2listw(knn3_nb_pri, style = "W"))
knn3_lw_B_pri <- nb2listw(knn3_nb_pri, style = "B")
moran.test(obesity_pri_sch$PREVALENCE, knn3_lw_pri)
moran.plot(obesity_pri_sch$PREVALENCE, knn3_lw_pri, main="Moran scatterplot")
geary.test(obesity_pri_sch$PREVALENCE, knn3_lw_pri)
globalG.test(obesity_pri_sch$PREVALENCE, knn3_lw_B_pri)

# by Secondary schools
(knn3_lw_sec <- nb2listw(knn3_nb_sec, style = "W"))
knn3_lw_B_sec <- nb2listw(knn3_nb_sec, style = "B")
moran.test(obesity_sec_sch$PREVALENCE, knn3_lw_sec)
moran.plot(obesity_sec_sch$PREVALENCE, knn3_lw_sec, main="Moran scatterplot")
geary.test(obesity_sec_sch$PREVALENCE, knn3_lw_sec)
globalG.test(obesity_sec_sch$PREVALENCE, knn3_lw_B_sec)
```

Average number of links (Primary school): 3
p-value for Global Moran's I test (Primary school): 7.811e-08
p-value for Global Geary's C test (Primary school): 9.495e-08
p-value for Global Getis-Ord's G test (Primary school): 0.00337

Average number of links (Secondary school): 3
p-value for Global Moran's I test (Secondary school): 0.000427
p-value for Global Geary's C test (Secondary school): 0.002858
p-value for Global Getis-Ord's G test (Secondary school): 0.3985

#### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by Primary school
obesity_pri_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_pri_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
pri_map <- ura_regions_map + obesity_pri_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_pri_sch$HIGH_PREVALENCE, 
                knn3_lw_B_pri) 

# by Secondary school
obesity_sec_sch$HIGH_PREVALENCE <- 
  as.factor(obesity_sec_sch$PREVALENCE > OVERWEIGHT_CUTOFF)
sec_map <- ura_regions_map + obesity_sec_sch %>% 
  tm_shape(name = "Overweight prevalence") + 
  tm_symbols(
    fill = "HIGH_PREVALENCE", 
    
    size = "PREVALENCE", size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide()) +
  tm_title("Join count analysis")
joincount.multi(obesity_sec_sch$HIGH_PREVALENCE, 
                knn3_lw_B_sec)

tmap_arrange(pri_map, sec_map)
```

#### Local Moran's I statistic
```{r}
# by Primary school
localm_knn3_pri <- 
  localmoran(obesity_pri_sch$PREVALENCE, 
             knn3_lw_pri)
obesity_pri_sch$LMORANZ <- localm_knn3_pri[,4]
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

# by Secondary school
localm_knn3_sec <- 
  localmoran(obesity_sec_sch$PREVALENCE, 
             knn3_lw_sec)
obesity_sec_sch$LMORANZ <- localm_knn3_sec[,4]
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "LMORANZ", size = 0.5) + 
  tm_title("Local Moran's I Z-Statistic")

tmap_arrange(pri_map, sec_map)
```

#### Local Getis-Ord's G statistics
```{r}
# by Primary school
obesity_pri_sch$GO_STAT <-
  localG(obesity_pri_sch$PREVALENCE, 
         knn3_lw_B_pri)
pri_map <- tm_shape(obesity_pri_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

# by Secondary school
obesity_sec_sch$GO_STAT <-
  localG(obesity_sec_sch$PREVALENCE, 
         knn3_lw_B_sec)
sec_map <- tm_shape(obesity_sec_sch) + tm_symbols(fill = "GO_STAT", size = 0.5) +
  tm_title("Local Getis-Ord's G statistics")

tmap_arrange(pri_map, sec_map)
```

#### Correlogram (does not work)
Some sub-graphs have 2 or less neighbours
```{r}
# # by Primary school
# correl_knn3_pri <- sp.correlogram(
#   knn3_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_knn3_pri <- sp.correlogram(
#   knn3_nb_pri, obesity_pri_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_knn3_pri <- sp.correlogram(
#   knn3_nb_pri, obesity_pri_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(2,3))
# plot(correl_knn3_pri, main="Contiguity lag orders: correlation")
# plot(correlI_knn3_pri, main="Contiguity lag orders: Moran's I")
# plot(correlC_knn3_pri, main="Contiguity lag orders: Geary's C")
# 
# # by Secondary school
# correl_knn3_sec <- sp.correlogram(
#   knn3_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "corr", style = "W")
# correlI_knn3_sec <- sp.correlogram(
#   knn3_nb_sec, obesity_sec_sch$PREVALENCE, 
#   order = 3, method = "I", style = "W")
# correlC_knn3_sec <- sp.correlogram(
#   knn3_nb_sec, obesity_sec_sch$PREVALENCE,
#   order = 3, method = "C", style = "W")
# plot(correl_knn3_sec, main="Contiguity lag orders: correlation")
# plot(correlI_knn3_sec, main="Contiguity lag orders: Moran's I")
# plot(correlC_knn3_sec, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))
```


# Elite metric (Lucas)

```{r}
pri_rankings <- read.csv("pri rankings.csv") %>% 
  mutate(School = toupper(School)) %>% 
  rename(is_popular_school = Balloting.2C) %>% 
  select(School, is_popular_school)
sec_rankings <- read.csv("sec rankings.csv") %>% 
  mutate(School = toupper(School)) %>% 
  rename(is_popular_school = Quartile.1) %>% 
  select(School, is_popular_school)
# obesity_data <- obesity_data %>% 
#   
# obesity_data <- obesity_data %>% 
#   left_join(sec_rankings, by = join_by(SCHOOL == School))

school_rankings <- rbind(pri_rankings, sec_rankings)
```

# Income distribution (Lucas)

```{r}
census <- read.csv("census stats.csv") %>% 
  mutate(PLN_AREA_N = toupper(PLN_AREA_N))

census_merge <- ura_planning_areas %>%
  left_join(census) %>%
  drop_na("Income")

ura_planning_areas_map + tm_shape(census_merge) + 
  tm_polygons(fill="Income", 
              fill.scale = tm_scale(breaks = c(6925,8396,9532,11317,16197))
              ) +
  tm_title("Breakdown by Household Income")

ura_planning_areas_map + tm_shape(census_merge) + 
  tm_polygons(fill="Education", 
              fill.scale = tm_scale(breaks = c(9.76,10.74,11.25,11.89,14.78))
              ) +
  tm_title("Breakdown by Education Level")

ura_planning_areas_map + tm_shape(census_merge) + 
  tm_polygons(fill="Primary", 
              fill.scale = tm_scale(breaks = c(61,4778,7043,11681,21822))
              ) +
  tm_title("Breakdown by Pri Students")

ura_planning_areas_map + tm_shape(census_merge) + 
  tm_polygons(fill="Secondary", 
              fill.scale = tm_scale(breaks=c(59,3526,4894,8804,13221))
              ) +
  tm_title("Breakdown by Sec Students")
```

# Spatial Descriptive Summary Measures of Income (Lucas)

```{r}
census_coords <- st_coordinates(st_point_on_surface(census_merge))
income_mean <- calc_mnc(id = 1, points = census_coords)
income_median <- calc_mdc(id = 2, points = census_coords)
income_mean_median <- rbind(income_mean$LOCATIONS, income_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
income_mean_median$id = c("Weighted mean", "Weighted median")

income_sdd <- calc_sdd(id = 3, points = census_coords)
income_sdd_line <- income_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_sde <- calc_sde(id = 4, points = census_coords)
income_sde_line <- income_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = census_merge$Income,
  points = census_coords)
income_sde_weighted_line <- income_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_map <- ura_planning_areas_map +
    tm_shape(census_merge, name = "Income") +
    tm_symbols(
        size = "Income",
        size.scale = tm_scale_continuous(values.scale = 0.8),
        size.legend = tm_legend_hide(),
        fill = "Income", 
        # a green-red diverging scale to indicate severity of overweight prevalence
        fill.scale = tm_scale_continuous(values = "brewer.yl_or_rd"), 
        fill.legend = tm_legend(
            title = "Income Distribution",
            orientation = "landscape", 
            position = c("BOTTOM", "LEFT"),
            item.height = 0.5, item.width = 2.1
        )
    ) + 
    tm_shape(income_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
    tm_shape(income_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
    tm_shape(income_sde_weighted_line, name = "weighted SDE") + 
    tm_lines(col = "red", lwd = 2, lty = 3) +
    tm_shape(income_mean_median, name = "Summary measures") + tm_dots(
        size = 0.5, shape = "id", fill = "white", 
        shape.legend = tm_legend("Summary measures")
    ) + 
    tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
    tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
    tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
    tm_title("Income Distribution across SG Planning Areas")

print(income_map)
```

# Spatial Descriptive Summary Measures of Education Years (Lucas)

```{r}
education_mean <- calc_mnc(id = 1, points = census_coords, weighted = T, weights = census_merge$Education)
education_median <- calc_mdc(id = 2, points = census_coords)
education_mean_median <- rbind(education_mean$LOCATIONS, education_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
education_mean_median$id = c("Weighted mean", "Weighted median")

education_sdd <- calc_sdd(id = 3, points = census_coords)
education_sdd_line <- education_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_sde <- calc_sde(id = 4, points = census_coords)
education_sde_line <- education_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = census_merge$Education,
  points = census_coords)
education_sde_weighted_line <- education_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_map <- ura_planning_areas_map +
    tm_shape(census_merge, name = "Education") +
    tm_symbols(
        size = "Education",
        size.scale = tm_scale_continuous(values.scale = 0.8),
        size.legend = tm_legend_hide(),
        fill = "Education", 
        # a green-red diverging scale to indicate severity of overweight prevalence
        fill.scale = tm_scale_continuous(values = "brewer.yl_or_rd"), 
        fill.legend = tm_legend(
            title = "Education Years",
            orientation = "landscape", 
            position = c("BOTTOM", "LEFT"),
            item.height = 0.5, item.width = 2.1
        )
    ) + 
    tm_shape(education_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
    tm_shape(education_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
    tm_shape(education_sde_weighted_line, name = "weighted SDE") + 
    tm_lines(col = "red", lwd = 2, lty = 3) +
    tm_shape(education_mean_median, name = "Summary measures") + tm_dots(
        size = 0.5, shape = "id", fill = "white", 
        shape.legend = tm_legend("Summary measures")
    ) + 
    tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
    tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
    tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
    tm_title("Education Years Across SG Planning Areas")

print(education_map)
```

# Food and Nutrition (Nina)

```{r}
#Data transformation

#Hawker Centres
hawker_full = st_read("NEAMarketandFoodCentre.geojson") %>%
  st_transform(crs = sg_crs)
hawker = hawker_full["geometry"]

#Fast Food Outlets 
  #Mcdonald's
macs_full = st_read("mcdonalds_singapore.geojson") %>%
  st_transform(crs = sg_crs) 
table(st_is_valid(macs_full)) #Check validity
st_crs(macs_full)$epsg #Check CRS
macs = macs_full[,"geometry"] #Extract necessary columns for analysis

  #7-11 Outlets
seven_eleven_full = st_read("711_singapore.geojson") %>%
  st_transform(crs = sg_crs)
seven_eleven = seven_eleven_full[,"geometry"] #Extract necessary columns for analysis
table(st_is_valid(seven_eleven)) #Check validity
st_crs(seven_eleven)$epsg #Check CRS

#Combine data into single SF object
seven_eleven_sf = mutate(seven_eleven, outlet = "7-11")
macs_sf = mutate(macs, outlet = "mcdonalds")
hawker_sf = mutate(hawker, outlet = "hawker")
food = rbind(seven_eleven_sf, macs_sf, hawker_sf)


##### Primary school analysis
obesity_pri_food = obesity_pri_sch #duplicate primary school data
st_crs(obesity_pri_food)$units #check units
pri_schools_buffer1 <- st_buffer(obesity_pri_food, dist = 1000) %>% st_geometry()
pri_intersections <- st_intersects(pri_schools_buffer1, food)

#Calculate the number of food outlets within a 1km radius of each school
obesity_pri_food$num_food_outlets <- lengths(pri_intersections)
obesity_pri_food

#Show density via choropleth map
pri_food_map = ura_regions_map + 
  tm_shape(obesity_pri_food) +
  tm_symbols(
    size = 0.5,
    fill = "num_food_outlets"
  ) +
  tm_title("Food Outlet Density by Primary School")

print(pri_food_map)


####Secondary school analysis
obesity_sec_food = obesity_sec_sch #duplicate secondary school data
st_crs(obesity_sec_food)$units #check units
sec_schools_buffer1 <- st_buffer(obesity_sec_food, dist = 1000) %>% st_geometry()
sec_intersections <- st_intersects(sec_schools_buffer1, food)

#calculate the number of food outlets within a 1km radius of each school
obesity_sec_food$num_food_outlets <- lengths(sec_intersections)
obesity_sec_food

#show density via choropleth map
sec_food_map = ura_regions_map + 
  tm_shape(obesity_sec_food) +
  tm_symbols(
    size = 0.5,
    fill = "num_food_outlets"
  ) +
  tm_title("Food Outlet Density by Secondary School")

print(sec_food_map)

###Spatial analysis - Secondary school
st_crs(obesity_sec_food)$proj #Check for metric units
obesity_sec_food_coords = st_coordinates(obesity_sec_food)

mean_sec_food = calc_mnc(id = 1, points = obesity_sec_food_coords)
median_sec_food = calc_mdc(id = 2, points = obesity_sec_food_coords)
sdd_sec_food = calc_sdd(id = 3, calccentre = T, weighted = F, points = obesity_sec_food_coords)

LC_sdd_line_sec_food = sdd_sec_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_sec_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING") # CRS from the parent object.

sde_sec_food = calc_sde(id=4, calccentre = T, weighted=F, points= obesity_sec_food_coords)
ls()
LC_sde_line_sec = sde_sec_food$LOCATIONS %>%
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_sec_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING") # CRS from the parent object.

(LC_sdd_line_sec = sdd_sec_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_sec_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING")) # CRS from the parent object.

(LC_std_dist_sec = st_sf(sdd_sec_food$ATTRIBUTES, geom=st_geometry(LC_sdd_line_sec))) 

LC_std_ellps_sec = st_sf(sde_sec_food$ATTRIBUTES, geom = st_geometry(LC_sde_line_sec))

#Plot the summary measures
(mean_median_sec = rbind(mean_sec_food$LOCATIONS, median_sec_food$LOCATIONS) %>% 
    data.frame() %>% 
    st_as_sf(coords=c("x","y"), crs=st_crs(obesity_sec_food))) # matrix -> data.frame -> sf points

mean_median_sec$id =  c("Spatial Mean","Spatial Median") # assign names
mean_median_sec

sec_food_map + 
  tm_shape(obesity_sec_food) +
  tm_shape(LC_std_ellps_sec) + tm_lines(lwd=2) + 
  tm_shape(LC_std_dist_sec) + tm_lines(lwd=2, lty=2) + 
  tm_shape(mean_median_sec) + tm_dots(size=0.5, shape="id", fill = "white", shape.legend = tm_legend_hide()) + 
  tm_compass(position = c("left", "top")) +
  tm_add_legend(type="symbols", labels="Spatial mean", shape = 1) +
  tm_add_legend(type="symbols", labels="Spatial median", shape = 0) +
  tm_add_legend(type="lines", labels="SDD", lty=2) + 
  tm_add_legend(type="lines", labels="SDE", lty=1)


##Spatial analysis - Primary school
st_crs(obesity_pri_food)$proj #Check for metric units 
obesity_pri_food_coords = st_coordinates(obesity_pri_food)

mean_pri_food = calc_mnc(id = 1, points = obesity_pri_food_coords)
median_pri_food = calc_mdc(id = 2, points = obesity_pri_food_coords)
sdd_pri_food = calc_sdd(id = 3, calccentre = T, weighted = F, points = obesity_pri_food_coords)

(LC_sdd_line_pri_food = sdd_pri_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_pri_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING")) # CRS from the parent object.

sde_pri_food = calc_sde(id=4, calccentre = T, weighted=F, points= obesity_pri_food_coords)
ls()
LC_sde_line_pri = sde_pri_food$LOCATIONS %>%
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_pri_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING") # CRS from the parent object.


(LC_sdd_line_pri = sdd_pri_food$LOCATIONS %>% 
    st_as_sf(coords = c("x", "y"), crs=st_crs(obesity_pri_food)) %>% 
    st_combine() %>% 
    st_cast("LINESTRING")) # CRS from the parent object.

(LC_std_dist_pri = st_sf(sdd_pri_food$ATTRIBUTES, geom=st_geometry(LC_sdd_line_pri))) 

LC_std_ellps_pri = st_sf(sde_pri_food$ATTRIBUTES, geom = st_geometry(LC_sde_line_pri))

#Plot the summary measures 
(mean_median_pri = rbind(mean_pri_food$LOCATIONS, median_pri_food$LOCATIONS) %>% 
    data.frame() %>% 
    st_as_sf(coords=c("x","y"), crs=st_crs(obesity_pri_food))) # matrix -> data.frame -> sf points

mean_median_pri$id =  c("Spatial Mean","Spatial Median") # assign names
mean_median_pri

pri_food_map + 
  tm_shape(obesity_pri_food) +
  tm_shape(LC_std_ellps_pri) + tm_lines(lwd=2) + 
  tm_shape(LC_std_dist_pri) + tm_lines(lwd=2, lty=2) + 
  tm_shape(mean_median_pri) + tm_dots(size=0.5, shape="id", fill = "white", shape.legend = tm_legend_hide()) + 
  tm_compass(position = c("left", "top")) +
  tm_add_legend(type="symbols", labels="Spatial mean", shape = 1) +
  tm_add_legend(type="symbols", labels="Spatial median", shape = 0) +
  tm_add_legend(type="lines", labels="SDD", lty=2) + 
  tm_add_legend(type="lines", labels="SDE", lty=1)
#Bivariate Moran's I
obesity_pri_food
coords_pri_sch <- st_coordinates(obesity_pri_food)
knn_nb_pri_sch_food <- knn2nb(knearneigh(coords_pri_sch, k = 3))
wts_pri_sch_food <- nb2listw(knn_nb_pri_sch_food, style = "W")
morans_bi_pri_food <- lm.morantest(lm(PREVALENCE ~ num_food_outlets, data = obesity_pri_food), listw = wts_pri_sch_food)
morans_bi_pri_food  #P-value = 4.071e-08, hence there is a significant relationship between obesity prevalence and number of food outlets


obesity_sec_food
coords_sec_sch <- st_coordinates(obesity_sec_food)
knn_nb_sec_sch_food <- knn2nb(knearneigh(coords_sec_sch, k = 3))
wts_sec_sch_food <- nb2listw(knn_nb_sec_sch_food, style = "W")
morans_bi_sec_food <- lm.morantest(lm(PREVALENCE ~ num_food_outlets, data = obesity_sec_food), listw = wts_sec_sch_food)
morans_bi_sec_food  #P-value = 0.0003288, hence there is a significant relationship between obesity prevalence and number of food outlets at a 5% sig level


```

#Distance of the nearest food option to each school
```{r} 
#Write function to compute distance to nearest food option, along with outlet_type
library(geosphere)

find_nearest_food_options <- function(schools_sf, food_options_sf) {

  if (st_crs(schools_sf) != st_crs(food_options_sf)) {
    stop("CRS of schools_sf and food_options_sf must be the same.")
  }

  distances <- st_distance(schools_sf, food_options_sf)

  nearest_indices <- apply(distances, 1, which.min)

  nearest_distances <- apply(distances, 1, min)

  nearest_outlet_types <- food_options_sf$outlet[nearest_indices]

    result_sf <- schools_sf %>%
    mutate(
      distance_to_nearest_food_option = as.numeric(nearest_distances),
      outlet_type = nearest_outlet_types
    ) %>%
    select(SCHOOL, distance_to_nearest_food_option, outlet_type, geometry)
  
  print(result_sf)
}


nearest_outlet_distance = find_nearest_food_options(obesity_data_sf_2023_OSO, food)
nearest_outlet_distance

#Combine data into original sf object
food_combined_sf = obesity_data_sf_2023_OSO %>%
  st_join(nearest_outlet_distance[,c(2,3)], by = "SCHOOL")

#Plot graph 
ura_regions_map +
  tm_shape(food_combined_sf) +
  tm_symbols(size = 0.5, fill = "distance_to_nearest_food_option")


food_combined_sf
coords_dist <- st_coordinates(food_combined_sf)
knn_nb_sec_sch_food <- knn2nb(knearneigh(coords_dist, k = 3))
wts_sec_sch_food <- nb2listw(knn_nb_sec_sch_food, style = "W")
morans_bi_sec_food <- lm.morantest(lm(PREVALENCE ~ num_food_outlets, data = obesity_sec_food), listw = wts_sec_sch_food)
morans_bi_sec_food  #P-value = 0.0003288, hence there is a significant relationship between obesity prevalence and number of food outlets at a 5% sig level
```




# Sports CCAs in Schools (Qasim)

```{r}
# Loading school co-curricular activities data
school_sports_ccas <- 
  read.csv("CocurricularactivitiesCCAs.csv") %>% 
  group_by(school_name,school_section) %>% 
  summarise(
    total = n(),
    physical_sports_count = sum(cca_grouping_desc == "PHYSICAL SPORTS")) %>% 
    select(school_name,school_section, physical_sports_count) %>% 
    filter(school_section != "JUNIOR COLLEGE")
  


#2023 OSO school obesity data combined with 2024-25 school physical activity cca data
#gives spatial awareness to physical activity cca by joining to obesity data set by school name
obesity_joined_school_sports_data <- 
  obesity_data_sf_2023_OSO %>% 
  left_join(school_sports_ccas, by = join_by(SCHOOL == school_name)) %>%
  mutate(sports_cca_per_100 = physical_sports_count / ENROLMENT * 100) #ratio of sports cca per 100 students
```

#Visualising physical sports participation by school level

###########################PRIMARY SCHOOL####################################

```{r}
# Primary school sports participation

#NEED TO AVERAGE VALUES FOR MISSING VALUES
pri_cca_data <- obesity_joined_school_sports_data %>% filter(LEVEL == "PRIMARY", !is.na(sports_cca_per_100))

pri_cca_map <- ura_planning_areas_map+  
  tm_shape(pri_cca_data) +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    shape = 21,  # circle
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"),
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
    )
  ) + 
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Ratio of Sports CCAs per 100 Students by Primary School"
  )

pri_cca_map 



# Spatial descriptive summary measures of physical sports participation by primary school

# Mean centre, standard deviation distance, standard deviation ellipse
pri_cca_mean <- calc_mnc(id = 1, points = st_coordinates(pri_cca_data))
pri_cca_median <- calc_mdc(id = 2, points = st_coordinates(pri_cca_data))
pri_cca_mean_median <- rbind(pri_cca_mean$LOCATIONS, pri_cca_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
pri_cca_mean_median$id = c("Spatial mean", "Spatial median")

pri_cca_sdd <- calc_sdd(id = 3, points = st_coordinates(pri_cca_data))
pri_cca_sdd_line <- pri_cca_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_sde <- calc_sde(id = 4, points = st_coordinates(pri_cca_data))
pri_cca_sde_line <- pri_cca_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = pri_cca_data$sports_cca_per_100,
  points = st_coordinates(pri_cca_data))
pri_cca_sde_weighted_line <- pri_cca_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_map_sde <- ura_planning_areas_map +
  tm_shape(pri_cca_data, name = "Ratio of Sports CCAs per 100 Students by School") +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(pri_cca_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(pri_cca_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(pri_cca_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(pri_cca_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Ratio of Sports CCAs per 100 Students by Primary School")

pri_cca_map_sde

```


####################################SECONDARY SCHOOL####################################
```{r}
sec_cca_data <- obesity_joined_school_sports_data %>% filter(LEVEL == "SECONDARY", !is.na(sports_cca_per_100))

sec_cca_map <- ura_planning_areas_map +  
  tm_shape(sec_cca_data) +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    shape = 22,  #square
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"),
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
    )
  ) + 
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Ratio of Sports CCAs per 100 Students by Secondary School"
  )


sec_cca_map



# Mean centre, standard deviation distance, standard deviation ellipse
sec_cca_mean <- calc_mnc(id = 1, points = st_coordinates(sec_cca_data))
sec_cca_median <- calc_mdc(id = 2, points = st_coordinates(sec_cca_data))
sec_cca_mean_median <- rbind(sec_cca_mean$LOCATIONS, sec_cca_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
sec_cca_mean_median$id = c("Spatial mean", "Spatial median")

sec_cca_sdd <- calc_sdd(id = 3, points = st_coordinates(sec_cca_data))
sec_cca_sdd_line <- sec_cca_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_sde <- calc_sde(id = 4, points = st_coordinates(sec_cca_data))
sec_cca_sde_line <- sec_cca_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = sec_cca_data$sports_cca_per_100,
  points = st_coordinates(sec_cca_data))
sec_cca_sde_weighted_line <- sec_cca_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_map_sde <- ura_planning_areas_map +
  tm_shape(sec_cca_data, name = "Ratio of Sports CCAs per 100 Students by School") +
  tm_symbols(
    shape = 22,
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(sec_cca_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(sec_cca_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(sec_cca_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(sec_cca_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Ratio of Sports CCAs per 100 Students by Secondary School")

sec_cca_map_sde


###################################################################

```


# Aggregating sports cca ratio counts by URA planning area
```{r}
cca_planning_avg <- st_join(ura_planning_areas, obesity_joined_school_sports_data) %>% 
  group_by(PLN_AREA_N, LEVEL) %>% 
  summarise(
    RATIO_AGG = mean(sports_cca_per_100, na.rm = T),
    geometry = st_union(geometry)
    ) %>%
  filter(!is.na(RATIO_AGG))

cca_planning_avg_map <- ura_planning_areas_map + cca_planning_avg %>% 
  tm_shape(name = "Sports CCA Ratio per 100") +
  tm_polygons(
    fill = "RATIO_AGG",
    fill.scale = tm_scale(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Average Sports CCAs Ratio by URA planning areas") +
  tm_facets_wrap(by = "LEVEL")

print(cca_planning_avg_map)







#raw cca avg for COMBINED schools
combined_cca_avg <- st_join(ura_planning_areas, obesity_joined_school_sports_data) %>% 
  group_by(PLN_AREA_N) %>% 
  summarise(
    RATIO_AGG = mean(sports_cca_per_100, na.rm = T),
    geometry = st_union(geometry)
    ) %>%
  filter(!is.na(RATIO_AGG))

```



#BIVARIATE CHLOROPLETH MAPS FOR CCA RATIO VS PREVALENCE
```{r}

library(classInt);library(dplyr)

#Select the two variables for the bivariate map
obesity_sports_data <- obesity_joined_school_sports_data %>% 
  filter(!is.na(sports_cca_per_100), !is.na(PREVALENCE)) %>%
  select(SCHOOL,LEVEL, sports_cca_per_100, PREVALENCE, geometry)

#primary school

pri_obesity_sports <- obesity_sports_data %>%
  filter(LEVEL == "PRIMARY") %>%
  select(-LEVEL)

pri_cca_prevalence <- st_join(ura_planning_areas, pri_obesity_sports) %>% 
  group_by(PLN_AREA_N) %>% 
  summarise(
    avg_cca_ratio = mean(sports_cca_per_100, na.rm = T),
    avg_prevalence = mean(PREVALENCE, na.rm = T),
  ) %>%
  filter(!is.na(avg_cca_ratio), !is.na(avg_prevalence))


#Classify both variables into 3 categories (low, medium, high)
pri_bc <- pri_cca_prevalence %>%
  mutate(
    sports_cat = cut(avg_cca_ratio, 
                     breaks = classIntervals(avg_cca_ratio, 3, style = "quantile")$brks, 
                     labels = c("Low", "Medium", "High"), 
                     include.lowest = TRUE),
    obesity_cat = cut(avg_prevalence, 
                      breaks = classIntervals(avg_prevalence, 3, style = "quantile")$brks, 
                      labels = c("Low", "Medium", "High"), 
                      include.lowest = TRUE)
  )

#Combine the two classifications into one
pri_bc <- pri_bc %>%
  mutate(bivariate_class = paste(sports_cat, obesity_cat, sep = "_"))


bivariate_colors <- c(
  "Low_Low" = "#e8e8e8", "Medium_Low" = "#b4d3e4", "High_Low" = "#8bb5d1",
  "Low_Medium" = "#e4b4b4", "Medium_Medium" = "#b4b4b4", "High_Medium" = "#8b8b8b",
  "Low_High" = "#d18b8b", "Medium_High" = "#b58b8b", "High_High" = "#8b8b8b"
)


pri_bivariate_map <-ura_planning_areas_map +
  tm_shape(pri_bc) +
  tm_polygons(fill = "bivariate_class", palette = bivariate_colors, title = "Bivariate Categories (CCA - Obesity)") +
  tm_layout(legend.position = c("right", "bottom")) +
  tm_title("Bivariate Map of Sports CCAs and Obesity Prevalence by URA Planning Areas (Primary Schools)")


pri_bivariate_map




# Secondary school bivariate map


sec_obesity_sports <- obesity_sports_data %>%
  filter(LEVEL == "SECONDARY") %>%
  select(-LEVEL)

sec_cca_prevalence <- st_join(ura_planning_areas, sec_obesity_sports) %>% 
  group_by(PLN_AREA_N) %>% 
  summarise(
    avg_cca_ratio = mean(sports_cca_per_100, na.rm = T),
    avg_prevalence = mean(PREVALENCE, na.rm = T),
  ) %>%
  filter(!is.na(avg_cca_ratio), !is.na(avg_prevalence))


#Classify both variables into 3 categories (low, medium, high)
sec_bc <- sec_cca_prevalence %>%
  mutate(
    sports_cat = cut(avg_cca_ratio, 
                     breaks = classIntervals(avg_cca_ratio, 3, style = "quantile")$brks, 
                     labels = c("Low", "Medium", "High"), 
                     include.lowest = TRUE),
    obesity_cat = cut(avg_prevalence, 
                      breaks = classIntervals(avg_prevalence, 3, style = "quantile")$brks, 
                      labels = c("Low", "Medium", "High"), 
                      include.lowest = TRUE)
  )

#Combine the two classifications into one
sec_bc <- sec_bc %>%
  mutate(bivariate_class = paste(sports_cat, obesity_cat, sep = "_"))


bivariate_colors <- c(
  "Low_Low" = "#e8e8e8", "Medium_Low" = "#b4d3e4", "High_Low" = "#8bb5d1",
  "Low_Medium" = "#e4b4b4", "Medium_Medium" = "#b4b4b4", "High_Medium" = "#8b8b8b",
  "Low_High" = "#d18b8b", "Medium_High" = "#b58b8b", "High_High" = "#8b8b8b"
)


sec_bivariate_map <-ura_planning_areas_map +
  tm_shape(sec_bc) +
  tm_polygons(fill = "bivariate_class", palette = bivariate_colors, title = "Bivariate Categories (CCA - Obesity)") +
  tm_layout(legend.position = c("right", "bottom")) +
  tm_title("Bivariate Map of Sports CCAs and Obesity Prevalence by URA Planning Areas (Secondary Schools)")


sec_bivariate_map
```


```{r}

#cca vs prevalence bivariate morans I

schools_coords <- obesity_joined_school_sports_data %>%
  filter(!is.na(sports_cca_per_100)) %>%
  st_coordinates()

cca_vs_obesity <- data.frame(
  prevalence = obesity_joined_school_sports_data$PREVALENCE,
  sports_cca_ratio = obesity_joined_school_sports_data$sports_cca_per_100
) %>% filter(!is.na(prevalence), !is.na(sports_cca_ratio))

cca_vs_obesity$z_obesity <- scale(cca_vs_obesity$prevalence)
cca_vs_obesity$z_sports_cca_ratio <- scale(cca_vs_obesity$sports_cca_ratio)

cca_nb_one <- knn2nb(knearneigh(schools_coords, k=1))
w <- nb2listw(cca_nb_one, style="W", zero.policy=TRUE)

##############################################################################################
lag_sports <- lag.listw(w, cca_vs_obesity$z_sports_cca_ratio) 

moran_sports <- moran.test(cca_vs_obesity$z_sports_cca_ratio, listw=w, y=lag_sports)

moran_obesity_sports <- moran.test(cca_vs_obesity$z_obesity, 
                                  lag.listw(w, cca_vs_obesity$z_sports_cca_ratio))

moran_sports_obesity <- moran.test(cca_vs_obesity$z_sports_cca_ratio, 
                                  lag.listw(w, cca_vs_obesity$z_obesity))
##################################################################################################
# Print results
print("Bivariate Moran's I: Obesity vs. Spatial Lag of Sports Clubs")
print(moran_obesity_sports)
print("Bivariate Moran's I: Sports Clubs vs. Spatial Lag of Obesity")
print(moran_sports_obesity)

# Create Moran scatterplot
plot(cca_vs_obesity$z_obesity, lag.listw(w, cca_vs_obesity$z_sports_cca_ratio),
     xlab="Obesity Prevalence (standardized)",
     ylab="Spatial Lag of Sports Club Ratio",
     main="Bivariate Moran's I Scatterplot")
abline(lm(lag.listw(w, cca_vs_obesity$z_sports) ~ analysis_data$z_obesity), col="red")
abline(h=0, v=0, lty=2)

# Calculate Local Bivariate Moran's I
local_biv_moran <- localmoran.bivand(analysis_data$z_obesity, 
                                    lag.listw(w, analysis_data$z_sports))

# Create a copy of the original sf object for mapping results
results_sf <- obesity_joined_sports_data
results_sf$local_biv_moran <- local_biv_moran[,1]
results_sf$p_value <- local_biv_moran[,5]
results_sf$significant <- ifelse(results_sf$p_value < 0.05, "Significant", "Not Significant")

# Map the local bivariate Moran's I values
tm_shape(results_sf) +
  tm_fill("local_biv_moran", 
          title="Local Bivariate Moran's I", 
          style="quantile", 
          palette="RdBu",
          midpoint=0) +
  tm_borders() +
  tm_layout(title="Spatial Association between Obesity and Sports Clubs")
```




# Sports Fields and Facilities
```{r}
# Loading sports facilities data
sports_facilities_file <- "SportSGSportFacilities.geojson"
sports_facilities_sf <- st_read(sports_facilities_file) %>% 
  st_transform(crs = sg_crs)

st_make_valid(sports_facilities_sf) # Check for invalid geometries
st_as_sf(st_make_valid(sports_facilities_sf)) # Fix invalid geometries


sport_sg_facility_map <- ura_planning_areas_map + tm_shape(sports_facilities_sf) +
  tm_polygons(size = 0.3,
          fill = "slateblue4",
          fill.legend = tm_legend(title = "Sports Fields"))

sport_sg_facility_map



# Loading Sports fields data
fields_shp <- 
  st_read("SportsFieldsSGSHP/PLAYSG.shp") %>% 
  st_make_valid() %>%
  st_as_sf() %>%
  st_transform(crs = sg_crs) 

sports_fields_map <- ura_planning_areas_map + tm_shape(fields_shp) +
    tm_dots(size = 0.3,
          fill = "slateblue2",
          fill.legend = tm_legend(title = "Sports Fields"),
          fill_alpha = 0.5)


sports_fields_map



#DATA SET OF CHOICE
# Loading dual use facilities data

dual_use_facilities <- 
  st_read("DualUseSchoolsSportsFacilitiesSHP/DUS_School_Sports_Facilities.shp") %>% 
  st_make_valid() %>%
  st_as_sf() %>%
  st_transform(crs = sg_crs) 

dus_facility_map <- ura_planning_areas_map + tm_shape(dual_use_facilities) +
    tm_dots(size = 0.3,
          fill = "navy",
          fill.legend = tm_legend(title = "Dual Use School Sports Facilities"),
          fill_alpha = 0.5)

dus_facility_map




#displaying schools and sports facilities on the same map

#primary schools
pri_dus_map <- ura_planning_areas_map + 
  tm_shape(pri_cca_data) +
  tm_symbols(
    size = 0.3,
    fill = "red"
  ) +
  tm_shape(dual_use_facilities) +
  tm_dots(
    size = 0.3,
    fill = "blue"
  ) +
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Primary Schools and Dual Use Sports Facilities"
  )

pri_dus_map


#seconadry schools
sec_dus_map <- ura_planning_areas_map + 
  tm_shape(sec_cca_data) +
  tm_symbols(
    size = 0.3,
    fill = "red"
  ) +
  tm_shape(dual_use_facilities) +
  tm_dots(
    size = 0.3,
    fill = "blue"
  ) +
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Secondary Schools and Dual Use Sports Facilities"
  )

sec_dus_map

```




# K Nearest Neighbours

#NEAREST SPORTS FACILITY TO SCHOOL

## 1 neighbour

```{r}

# Calculate distances
distances <- st_distance(obesity_joined_school_sports_data, dual_use_facilities)

# For each school, find the k nearest facilities
k <- 3  # Change this to your desired k value
nearest_facilities <- list()

for (i in 1:nrow(obesity_joined_school_sports_data)) {
  # Get distances from this school to all facilities
  school_distances <- distances[i,]
  
  # Find indices of k nearest facilities (or fewer if there aren't k facilities)
  nearest_indices <- order(school_distances)[1:min(k, length(school_distances))]
  
  # Store these indices
  nearest_facilities[[i]] <- nearest_indices
}

# Create a data frame with the results
results <- data.frame(
  school_id = obesity_joined_school_sports_data$PT_ID,
  school_name = obesity_joined_school_sports_data$SCHOOL,
  level = obesity_joined_school_sports_data$LEVEL,
  geometry = obesity_joined_school_sports_data$geometry,
  stringsAsFactors = FALSE
)

# Add the nearest facilities for each school
for (j in 1:k) {
  facility_col <- paste0("nearest_facility_", j)
  distance_col <- paste0("distance_", j)
  
  results[[facility_col]] <- sapply(1:nrow(obesity_joined_school_sports_data),
  function(i) {
    if (length(nearest_facilities[[i]]) >= j) {
      # Return the ID of the jth nearest facility using the OBJECTID column
      dual_use_facilities$OBJECTID[nearest_facilities[[i]][j]]
    } else {
      NA
    }
  })
  
  results[[distance_col]] <- sapply(1:nrow(obesity_joined_school_sports_data),
  function(i) {
    if (length(nearest_facilities[[i]]) >= j) {
      # Return the distance to the jth nearest facility in meters
      as.numeric(distances[i, nearest_facilities[[i]][j]])
    } else {
      NA
    }
  })
}

pri_knn_3 <- results %>% filter(level == "PRIMARY") 
sec_knn_3 <- results %>% filter(level == "SECONDARY")



pri_nearest_dus <- st_as_sf(pri_knn_3, crs = sg_crs)
sec_nearest_dus <- st_as_sf(sec_knn_3, crs = sg_crs)


#AVERAGE DISTANCE TO THE NEAREST SPORTS FACILITY FROM SCHOOLS

#Heat map of nearest sports facility to schools - PRIMARY SCHOOLS
pri_dus_avg_distance <- st_join(ura_planning_areas, pri_nearest_dus) %>% 
  group_by(PLN_AREA_N, level) %>% 
  summarise(
    avg_distance = mean(distance_1, na.rm = T),
    geometry = st_union(geometry)
    ) %>%
  filter(!is.na(avg_distance))

pri_dus_avg_distance_map <- ura_planning_areas_map + pri_dus_avg_distance %>% 
  tm_shape(name = "Average Distance to Nearest DUS Sports Facility") +
  tm_polygons(
    fill = "avg_distance",
    fill.scale = tm_scale(values = "-brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Average Distance in Metres",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Average Distance to Nearest DUS Sports Facility from Primary Schools")

print(pri_dus_avg_distance_map)




#Heat map of nearest sports facility to schools - SECONDARY SCHOOLS 
sec_dus_avg_distance <- st_join(ura_planning_areas, sec_nearest_dus) %>% 
  group_by(PLN_AREA_N, level) %>% 
  summarise(
    avg_distance = mean(distance_1, na.rm = T),
    geometry = st_union(geometry)
    ) %>%
  filter(!is.na(avg_distance))

sec_dus_avg_distance_map <- ura_planning_areas_map + sec_dus_avg_distance %>% 
  tm_shape(name = "Average Distance to Nearest DUS Sports Facility") +
  tm_polygons(
    fill = "avg_distance",
    fill.scale = tm_scale(values = "-brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Average Distance in Metres",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Average Distance to Nearest DUS Sports Facility from Secondary Schools")

print(sec_dus_avg_distance_map)


```


# Facility Density by URA Planning Area
```{r}

facility_by_area <- st_join(ura_planning_areas, dual_use_facilities) %>% 
  group_by(PLN_AREA_N) %>% 
  filter(!is.na(OBJECTID)) %>%
  select(PLN_AREA_N, OBJECTID) 

facility_by_area <- facility_by_area %>%
  group_by(PLN_AREA_N) %>%
  summarise(facility_count = n())

facility_by_area$area_km2 <- as.numeric(st_area(facility_by_area)) / 1e6

facility_by_area$facility_density <- facility_by_area$facility_count / facility_by_area$area_km2


facility_density_map <- ura_planning_areas_map + facility_by_area %>% 
  tm_shape(name = "DUS Sports Facility Density by URA Planning Area") +
  tm_polygons(
    fill = "facility_density",
    fill.scale = tm_scale(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "DUS Facilities per km²",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("DUS Sports Facility Density by URA Planning Area")


facility_density_map

```



# Modelling obesity in Singapore schools

## Joining data variables
```{r}
school_sports_ccas_data <- school_sports_ccas %>%
  select(-school_section)

census_merge_data <- census_merge %>% 
  st_drop_geometry() %>% 
  select(PLN_AREA_N, Income, Education) 

nearest_outlet_distance_data <- nearest_outlet_distance %>% 
  st_drop_geometry()

num_food_outlets_data <- 
  rbind(
    select(st_drop_geometry(obesity_pri_food), PT_ID, num_food_outlets),
    select(st_drop_geometry(obesity_sec_food), PT_ID, num_food_outlets)
    )

obesity_overall_data <-
  obesity_data_sf_2023_OSO %>% 
  left_join(school_sports_ccas_data, by = join_by(SCHOOL == school_name)) %>%
  mutate(sports_cca_per_100 = physical_sports_count / ENROLMENT * 100) %>% 
  st_join(ura_planning_areas) %>% 
  left_join(census_merge_data, by = join_by(PLN_AREA_N)) %>% 
  left_join(school_rankings, by = join_by(SCHOOL == School)) %>% 
  left_join(nearest_outlet_distance_data, by = join_by(SCHOOL)) %>% 
  left_join(num_food_outlets_data, by = join_by(PT_ID)) %>% 
  st_drop_geometry()
```

## Correlation analysis

We must ensure that the predictors are correlated with the dependent variable and uncorrelated with each other (there is no multicollinearity). Correlation among predictors cause problems as interpretations become difficult as everything changes when one predictor changes. In addition collinearity makes inferences less reliable (power of tests are reduced).

```{r}
# Convert selected columns to numeric (handling factors correctly)
obesity_num_data <- obesity_overall_data[, c(20:22, 24, 26:27, 29:30, 32, 34)] 
rmat <- cor(obesity_num_data)
corrplot.mixed(rmat, upper = "pie", number.cex=0.75, tl.cex = 0.75,
               upper.col = COL2("PiYG"), lower.col = COL2("PiYG"))
```

Based on the sign of the correlation coefficient values, we can observe a positive linear relationship between median housing value (medv) and the

-   proportion of land zoned for large residential projects (zn),

-   average number of rooms (rm),

-   proximity to employment districts (dis), and

-   the proportion of African American (B).

Further, there is a negative linear relationship between medv and the

-   crime rate (crim).

-   proportion of non-consumer businesses (indus).

-   nitrogen oxides concentration (nox).

-   proportion of older units (age).

-   proximity to highways (rad).

-   property tax (tax).

-   pupil to teacher ratio (ptratio).

-   proportion of lower status occupants (lstat).

# Other Useful stuff

```{r}
tmap_mode("view") #interactive map
tmap_mode("plot") #static map
# tmap_save(tmap_object, 'xx.jpg') # for saving maps as images
cols4all::c4a_gui() # colour scales
RColorBrewer::display.brewer.all()
```
