# Data loading, cleaning and transformation

## Loading the data

Change the file paths accordingly

```{r}
# Loading libraries to work with spatial data
library(tidyverse); library(sf); library(tmap); library(aspace); library(spdep); library(corrplot)

# Loading Singapore URA subzone boundary data
sg_ura_boundaries <- 
  st_read("MasterPlan2014SubzoneBoundaryWebSHP/MP14_SUBZONE_WEB_PL.shp") %>% 
  st_make_valid()

# Saving CRS provided by SG boundary map
sg_crs <- st_crs(sg_ura_boundaries)

# Loading cleaned obesity data from HPB and giving spatial awareness
obesity_data <- 
  # "#N/A" values converted to "NA" for R to be able to read it
  read.csv("obesity.csv", na.strings = "#N/A") %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  st_transform(crs = sg_crs) %>% 
  st_make_valid()

# Loading cleaned HMSP data from HPB and giving spatial awareness
hmsp_data_sf <- 
  read.csv("hmsp_tier_pri_sec.csv") %>% 
  st_as_sf(coords = c("longitude","latitude"), crs = 4326) %>% 
  st_transform(crs = sg_crs) %>% 
  st_make_valid() 

# Checking that all CRS are matching
isTRUE(all.equal(st_crs(sg_ura_boundaries), st_crs(obesity_data), st_crs(hmsp_data_sf)))

# Checking CRS units
st_crs(sg_ura_boundaries)$units
st_crs(obesity_data)$units
st_crs(hmsp_data_sf)$units
```

## Transforming data to be usable for analysis

```{r}
obesity_data_sf <- obesity_data %>% 
  pivot_longer(
    # pivot_longer to separate obesity data columns into a tidy format
    cols = starts_with("X"),
    names_to = c("YEAR", "CATEGORY"),
    names_prefix = "X",
    names_sep = "_",
    names_transform = list(YEAR = as.integer),
    values_to = "COUNT"
    ) %>% 
  mutate(
    # Transform obesity count and school enrollment into an obesity prevalence figure
    PREVALENCE = COUNT / ENROLMENT
    )
```

We filter our data for the most recent year as the enrollment data given is for 2024. We focus on the number of students categorised as Overweight or Severely Overweight (OSO).
We remove "FUCHUN SECONDARY SCHOOL" as the enrollment data may be inaccurate due to school mergers.

```{r}
# for now, filter for 2023 data and overweight and severely overweight
obesity_data_sf_2023_OSO <- obesity_data_sf %>% 
  filter(YEAR == 2023, CATEGORY == "OSO", SCHOOL != "FUCHUN SECONDARY SCHOOL")
```

# Exploratory data analysis (by Prof)

```{r}
tmap_mode("plot")
tm_shape(sg_ura_boundaries) + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.4, fill = "TIER", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "HMSP Tiers"))

tm_shape(sg_ura_boundaries) + tm_fill() + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.4, fill = "ZONE", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "School zones"))

tm_shape(sg_ura_boundaries) + tm_fill() + tm_borders() +
  tm_shape(hmsp_data_sf) +
  tm_symbols(size = 0.3, fill = "CLUSTER", 
             fill.scale = tm_scale(values = "brewer.set1"), 
             fill.legend = tm_legend(title = "School clusters")) +
  tm_facets_wrap(by = "ZONE")
```


# Singapore maps

These are maps that define Singapore's regions based on URA defined boundaries (region, planning area, subzone) and MOE defined boundaries (zone, cluster). Subsequently, the defined regions can be used together with aggregated data so that we can examine overweight prevalence and other contributing factors by these differently delimited regions.

```{r}
tmap_mode("view")

# URA regions map
ura_regions <- sg_ura_boundaries %>% group_by(REGION_N) %>% 
  summarise(geometry = st_union(geometry))
ura_regions_map <- tm_shape(ura_regions, name = "URA regions") + tm_polygons(
    col = "grey", fill = "REGION_N", fill_alpha = 0.25, 
    fill.legend = tm_legend(title = "URA regions"))

# URA planning areas map
ura_planning_areas <- sg_ura_boundaries %>% group_by(PLN_AREA_N) %>% 
  summarise(geometry = st_union(geometry))
ura_planning_areas_map <- tm_shape(ura_planning_areas, name = "URA planning areas") + 
  tm_polygons(
    col = "grey", fill = "PLN_AREA_N", fill_alpha = 0.25, 
    fill.legend = tm_legend_hide())

# URA subzones map
ura_subzones <- sg_ura_boundaries %>% group_by(SUBZONE_N) %>% 
  summarise(geometry = st_union(geometry))
ura_subzones_map <- tm_shape(ura_subzones, name = "URA subzones") + tm_polygons(
  col = "grey", fill = "SUBZONE_N", fill_alpha = 0.25, 
  fill.legend = tm_legend_hide())

# MOE zones map
moe_zones <- obesity_data %>% group_by(ZONE) %>% 
  summarise(geometry = st_union(geometry)) %>% st_convex_hull()
moe_zone_map <- tm_shape(moe_zones, name = "MOE zones") + tm_polygons(
  col = "grey", fill = "ZONE", fill_alpha = 0.25, 
  fill.legend = tm_legend(title = "MOE School Zones"))

# MOE clusters map
moe_clusters <- obesity_data %>% group_by(CLUSTER) %>% 
  summarise(geometry = st_union(geometry)) %>% st_convex_hull()
moe_cluster_map <- tm_shape(moe_clusters, name = "MOE clusters") + tm_polygons(
  col = "grey", fill = "CLUSTER", fill_alpha = 0.25, 
  fill.legend = tm_legend_hide())
```

# Obesity profile in Singapore (Colin)

## Obesity prevalence overview map

The following map is an overview of overweight prevalence in Singapore schools. You may use the different layers provided in the map to view the individual school data against URA regions, planning areas and subzones, or MOE zones and clusters. Note that MOE zones and clusters have overlapping areas.

```{r}
tmap_mode("view")

# School obesity map plot
school_obesity_map <- tm_shape(obesity_data_sf_2023_OSO, name = "Overweight prevalence") +
  tm_symbols(
    size = 0.5,
    shape = "LEVEL",
    shape.legend = tm_legend(
      position = c("BOTTOM", "CENTER"),
      title = "Educational level"
      ),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    )

# Overview of overweight prevalence levels in Singapore schools
ura_regions_map + ura_planning_areas_map + ura_subzones_map + 
  moe_zone_map + moe_cluster_map +
  school_obesity_map +
  tm_title("Overview of overweight prevalence in Singapore schools")
```

## Obesity prevalence by educational level

We examine overweight prevalence in Singapore schools by educational level: Primary school or Secondary school. Primary school and secondary school students have different characteristics that might affect overweight prevalance.

The spatial mean centre (unweighted) and spatial variance (using the standard deviation distance and standard deviation ellipse) are calculated and plotted for each educational level.

### by Primary School

```{r}
tmap_mode("view")

# filter out by educational level and remove NA values to calculate SDE
obesity_pri_sch <- obesity_data_sf_2023_OSO %>% 
  filter(PRI == 1, !is.na(PREVALENCE))

obesity_data_sf_2023_OSO %>% summary()

# Mean centre, standard deviation distance, standard deviation ellipse
pri_sch_mean <- calc_mnc(id = 1, points = st_coordinates(obesity_pri_sch))
pri_sch_median <- calc_mdc(id = 2, points = st_coordinates(obesity_pri_sch))
pri_sch_mean_median <- rbind(pri_sch_mean$LOCATIONS, pri_sch_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
pri_sch_mean_median$id = c("Spatial mean", "Spatial median")

pri_sch_sdd <- calc_sdd(id = 3, points = st_coordinates(obesity_pri_sch))
pri_sch_sdd_line <- pri_sch_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_sde <- calc_sde(id = 4, points = st_coordinates(obesity_pri_sch))
pri_sch_sde_line <- pri_sch_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = obesity_pri_sch$PREVALENCE,
  points = st_coordinates(obesity_pri_sch))
pri_sch_sde_weighted_line <- pri_sch_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_sch_map <- ura_regions_map +
  tm_shape(obesity_pri_sch, name = "Overweight prevalence") +
  tm_symbols(
    size = "PREVALENCE",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(pri_sch_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(pri_sch_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(pri_sch_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(pri_sch_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Overweight prevalence in Primary Schools")

print(pri_sch_map)
```

### by Secondary School

```{r}
tmap_mode("view")

# filter out by educational level and remove NA values to calculate SDE
obesity_sec_sch <- obesity_data_sf_2023_OSO %>% 
  filter(SEC == 1, !is.na(PREVALENCE))

# Mean centre, standard deviation distance, standard deviation ellipse
sec_sch_mean <- calc_mnc(id = 1, points = st_coordinates(obesity_sec_sch))
sec_sch_median <- calc_mdc(id = 2, points = st_coordinates(obesity_sec_sch))
sec_sch_mean_median <- rbind(sec_sch_mean$LOCATIONS, sec_sch_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
sec_sch_mean_median$id = c("Spatial mean", "Spatial median")

sec_sch_sdd <- calc_sdd(id = 3, points = st_coordinates(obesity_sec_sch))
sec_sch_sdd_line <- sec_sch_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_sde <- calc_sde(id = 4, points = st_coordinates(obesity_sec_sch))
sec_sch_sde_line <- sec_sch_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = obesity_sec_sch$PREVALENCE,
  points = st_coordinates(obesity_sec_sch))
sec_sch_sde_weighted_line <- sec_sch_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_sch_map <- ura_regions_map +
  tm_shape(obesity_sec_sch, name = "Overweight prevalence") +
  tm_symbols(
    size = "PREVALENCE",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "PREVALENCE", 
    # a green-red diverging scale to indicate severity of overweight prevalence
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence by school",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(sec_sch_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(sec_sch_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(sec_sch_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(sec_sch_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Overweight prevalence in Secondary Schools")

print(sec_sch_map)

# tmap_arrange(pri_sch_map, sec_sch_map, nrow = 1)
```

Generally, we observe greater overweight prevalence levels for schools in the North and lower overweight prevalence levels in the South and Central regions of Singapore.

## Obesity prevalence by region

We aggregating overweight counts and school enrollment data by the different delimited regions, and fill in the regions to get visualise overweight prevalance by region.

```{r}
# Aggregating overweight counts by URA regions
obesity_ura_regions <- st_join(ura_regions, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(REGION_N) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_regions_map + obesity_ura_regions %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    # fill.scale = tm_scale_continuous(values = "-brewer.rd_yl_gn"), 
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      # orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA regions")

# Aggregating overweight counts by URA planning areas
obesity_ura_planning_areas <- st_join(ura_planning_areas, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(PLN_AREA_N) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_planning_areas_map + obesity_ura_planning_areas %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA planning areas")

# Aggregating overweight counts by URA subzones
obesity_ura_subzones <- st_join(ura_subzones, obesity_data_sf) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(SUBZONE_N) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

ura_subzones_map + obesity_ura_subzones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Overweight prevalence by URA subzones")

# Aggregating overweight counts by MOE school zones
obesity_moe_zones <- 
  # we left_join instead of st_join due to overlapping boundaries
  left_join(moe_zones, st_drop_geometry(obesity_data_sf)) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(ZONE) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

moe_zone_map +
  tm_legend_hide() + 
  obesity_moe_zones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill_alpha = 0.95,
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1,
      show = T
      )
    ) +
  tm_title("Overweight prevalence by MOE clusters")

# Aggregating overweight counts by MOE clusters
obesity_moe_clusters <- 
  left_join(moe_clusters, st_drop_geometry(obesity_data_sf)) %>% 
  filter(YEAR == 2023, CATEGORY == "OSO") %>% 
  group_by(CLUSTER) %>% 
  summarise(
    PREVALENCE_AGGREGATE = sum(COUNT, na.rm = T) / sum(ENROLMENT, na.rm = T),
    geometry = st_union(geometry)
    )

moe_cluster_map + obesity_moe_clusters %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(
    fill = "PREVALENCE_AGGREGATE",
    fill_alpha = 0.95,
    fill.scale = tm_scale(
      breaks = c(0, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30),
      values = "-brewer.rd_yl_gn"
      ), 
    fill.legend = tm_legend(
      title = "Overweight prevalence",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1,
      show = T
      )
    ) +
  tm_title("Overweight prevalence by MOE clusters")
```

```{r}
# Visualise obesity data in a chloropleth map
```

## Spatial dependence of obesity in Singapore schools

```{r}
# Contiguous neighbours by URA regions
ura_regions_nb <- poly2nb(obesity_ura_regions, queen = T) # queen contiguity
ura_regions_coords <- st_point_on_surface(st_geometry(obesity_ura_regions))
plot(st_geometry(ura_regions), border = "grey", axes = T, 
     main="SG schools contiguous neighbours by region")
plot.nb(ura_regions_nb, ura_regions_coords, pch = 19, cex = 0.6, add = T)

# Contiguous neighbours by URA planning areas
ura_planning_areas_nb <- poly2nb(obesity_ura_planning_areas, queen = T) # queen contiguity
ura_planning_areas_coords <- st_point_on_surface(st_geometry(obesity_ura_planning_areas))
plot(st_geometry(ura_planning_areas), border = "grey", axes = T, 
     main="SG schools contiguous neighbours by planning area")
plot.nb(ura_planning_areas_nb, ura_planning_areas_coords, pch = 19, cex = 0.6, add = T)

# Contiguous neighbours by URA subzones
ura_subzones_nb <- poly2nb(obesity_ura_subzones, queen = T) # queen contiguity
ura_subzones_coords <- st_point_on_surface(st_geometry(obesity_ura_subzones))
plot(st_geometry(ura_subzones), border = "grey", axes = T, 
     main="SG schools contiguous neighbours by subzone")
plot.nb(ura_subzones_nb, ura_subzones_coords, pch = 19, cex = 0.6, add = T)
```

### Join count analysis

```{r}
# Setting an overweight cutoff point
OVERWEIGHT_CUTOFF <- 0.14

# by URA region
ura_regions_lw <- nb2listw(ura_regions_nb, style = "W", zero.policy = T)
ura_regions_lw_B <- nb2listw(ura_regions_nb, style = "B", zero.policy = T)

obesity_ura_regions$HIGH_PREVALANCE <- 
  as.factor(obesity_ura_regions$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)

ura_regions_map + obesity_ura_regions %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(fill = "HIGH_PREVALANCE") +
  tm_title("Overweight prevalence by URA regions")

joincount.multi(obesity_ura_regions$HIGH_PREVALANCE, listw = ura_regions_lw_B) # too few cells

# by URA planning area
ura_planning_areas_lw <- nb2listw(ura_planning_areas_nb, style = "W", zero.policy = T)
ura_planning_areas_lw_B <- nb2listw(ura_planning_areas_nb, style = "B", zero.policy = T)

obesity_ura_planning_areas$HIGH_PREVALANCE <- 
  as.factor(obesity_ura_planning_areas$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)

ura_planning_areas_map + obesity_ura_planning_areas %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(fill = "HIGH_PREVALANCE") +
  tm_title("Overweight prevalence by URA planning areas")

joincount.multi(obesity_ura_planning_areas$HIGH_PREVALANCE, listw = ura_planning_areas_lw_B) 

# by URA subzone (empty neighbour sets exist)
ura_subzones_lw <- nb2listw(ura_subzones_nb, style = "W", zero.policy = T)
ura_subzones_lw_B <- nb2listw(ura_subzones_nb, style = "B", zero.policy = T)

obesity_ura_subzones$HIGH_PREVALANCE <- 
  as.factor(obesity_ura_subzones$PREVALENCE_AGGREGATE > OVERWEIGHT_CUTOFF)

ura_subzones_map + obesity_ura_subzones %>% 
  tm_shape(name = "Overweight prevalence") +
  tm_polygons(fill = "HIGH_PREVALANCE") +
  tm_title("Overweight prevalence by URA subzones")

joincount.multi(obesity_ura_subzones$HIGH_PREVALANCE, listw = ura_subzones_lw_B) 
```

### Moran's I statistic

```{r}
# by URA region
moran.test(obesity_ura_regions$PREVALENCE_AGGREGATE, 
           listw = ura_regions_lw, 
           alternative = "greater")
moran.plot(obesity_ura_regions$PREVALENCE_AGGREGATE, 
           listw = ura_regions_lw, 
           main="Moran scatterplot", 
           labels = F)

# by URA planning area
moran.test(obesity_ura_planning_areas$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw, 
           alternative = "greater")
moran.plot(obesity_ura_planning_areas$PREVALENCE_AGGREGATE, 
           listw = ura_planning_areas_lw, 
           main="Moran scatterplot", 
           labels = F)

# by URA subzone (empty neighbour sets exist)
moran.test(obesity_ura_subzones$PREVALENCE_AGGREGATE, 
           listw = ura_subzones_lw, 
           alternative = "greater")
moran.plot(obesity_ura_subzones$PREVALENCE_AGGREGATE, 
           listw = ura_subzones_lw, 
           main="Moran scatterplot", 
           labels = F)
```

### Local Moran's I statistic

Local Moran's I statistic may be biased towards border regions (identifies clustering in border regions with less neighbours even if clustering may not be present)

```{r}
# # by URA region (not possible)
# localm_ura_regions <- 
#   localmoran(obesity_ura_regions$PREVALENCE_AGGREGATE, listw = ura_regions_lw)
# obesity_ura_regions$LMORANZ <- localm_ura_regions[,4]
# tm_shape(obesity_ura_regions) + tm_polygons(fill = "LMORANZ") + 
#   tm_layout(title = "Local Moran's I Z-Statistic (URA regions)")

# by URA planning area
localm_ura_planning_areas <- 
  localmoran(obesity_ura_planning_areas$PREVALENCE_AGGREGATE, listw = ura_planning_areas_lw)
obesity_ura_planning_areas$LMORANZ <- localm_ura_planning_areas[,4]
tm_shape(obesity_ura_planning_areas) + tm_polygons(fill = "LMORANZ") + 
  tm_layout(title = "Local Moran's I Z-Statistic (URA planning_areas)")

# by URA subzone (empty neighbour sets exist)
localm_ura_subzones <- 
  localmoran(obesity_ura_subzones$PREVALENCE_AGGREGATE, listw = ura_subzones_lw)
obesity_ura_subzones$LMORANZ <- localm_ura_subzones[,4]
tm_shape(obesity_ura_subzones) + tm_polygons(fill = "LMORANZ") + 
  tm_layout(title = "Local Moran's I Z-Statistic (URA subzones)")
```

### Geary's C statistic

```{r}
# by URA region
geary.test(obesity_ura_regions$PREVALENCE_AGGREGATE, listw = ura_regions_lw)

# by URA planning area
geary.test(obesity_ura_planning_areas$PREVALENCE_AGGREGATE, listw = ura_planning_areas_lw)

# by URA subzone (empty neighbour sets exist)
geary.test(obesity_ura_subzones$PREVALENCE_AGGREGATE, listw = ura_subzones_lw)
```

### Getis-Ord's G statistics

```{r}
# by URA region
globalG.test(obesity_ura_regions$PREVALENCE_AGGREGATE, listw = ura_regions_lw_B)

# by URA planning area
globalG.test(obesity_ura_planning_areas$PREVALENCE_AGGREGATE, listw = ura_planning_areas_lw_B)

# by URA subzone (empty neighbour sets exist)
globalG.test(obesity_ura_subzones$PREVALENCE_AGGREGATE, listw = ura_subzones_lw_B)
```

### Local Getis-Ord's G statistics

```{r}
# by URA region
obesity_ura_regions$GO_STAT <-
  localG(obesity_ura_regions$PREVALENCE_AGGREGATE, listw = ura_regions_lw_B)
tm_shape(obesity_ura_regions) + tm_polygons("GO_STAT")

# by URA planning area
obesity_ura_planning_areas$GO_STAT <-
  localG(obesity_ura_planning_areas$PREVALENCE_AGGREGATE, listw = ura_planning_areas_lw_B)
tm_shape(obesity_ura_planning_areas) + tm_polygons("GO_STAT")

# by URA subzone (empty neighbour sets exist)
obesity_ura_subzones$GO_STAT <-
  localG(obesity_ura_subzones$PREVALENCE_AGGREGATE, listw = ura_subzones_lw_B)
tm_shape(obesity_ura_subzones) + tm_polygons("GO_STAT")
```

### Correlogram

```{r}
# # by URA region (too few observations)
# correl_ura_regions <- sp.correlogram(
#   neighbours = ura_regions_nb, 
#   var = obesity_ura_regions$PREVALENCE_AGGREGATE, 
#   order = 3, method = "corr", style = "W")
# correlI_ura_regions <- sp.correlogram(
#   neighbours = ura_regions_nb, 
#   var = obesity_ura_regions$PREVALENCE_AGGREGATE, 
#   order = 3, method = "I", style = "W")
# correlC_ura_regions <- sp.correlogram(
#   neighbours = ura_regions_nb, 
#   var = obesity_ura_regions$PREVALENCE_AGGREGATE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(1,3))
# plot(correl_ura_regions, main="Contiguity lag orders: correlation")
# plot(correlI_ura_regions, main="Contiguity lag orders: Moran's I")
# plot(correlC_ura_regions, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))

# by URA planning area
correl_planning_areas <- sp.correlogram(
  neighbours = ura_planning_areas_nb, 
  var = obesity_ura_planning_areas$PREVALENCE_AGGREGATE, 
  order = 3, method = "corr", style = "W")
correlI_planning_areas <- sp.correlogram(
  neighbours = ura_planning_areas_nb, 
  var = obesity_ura_planning_areas$PREVALENCE_AGGREGATE, 
  order = 3, method = "I", style = "W")
correlC_planning_areas <- sp.correlogram(
  neighbours = ura_planning_areas_nb, 
  var = obesity_ura_planning_areas$PREVALENCE_AGGREGATE,
  order = 3, method = "C", style = "W")
par(mfrow=c(1,3))
plot(correl_planning_areas, main="Contiguity lag orders: correlation")
plot(correlI_planning_areas, main="Contiguity lag orders: Moran's I")
plot(correlC_planning_areas, main="Contiguity lag orders: Geary's C")
par(mfrow=c(1,1))

# # by URA subzone (empty neighbour sets exist)
# correl_subzones <- sp.correlogram(
#   neighbours = ura_subzones_nb, 
#   var = obesity_ura_subzones$PREVALENCE_AGGREGATE, 
#   order = 3, method = "corr", style = "W")
# correlI_subzones <- sp.correlogram(
#   neighbours = ura_subzones_nb, 
#   var = obesity_ura_subzones$PREVALENCE_AGGREGATE, 
#   order = 3, method = "I", style = "W")
# correlC_subzones <- sp.correlogram(
#   neighbours = ura_subzones_nb, 
#   var = obesity_ura_subzones$PREVALENCE_AGGREGATE,
#   order = 3, method = "C", style = "W")
# par(mfrow=c(1,3))
# plot(correl_subzones, main="Contiguity lag orders: correlation")
# plot(correlI_subzones, main="Contiguity lag orders: Moran's I")
# plot(correlC_subzones, main="Contiguity lag orders: Geary's C")
# par(mfrow=c(1,1))
```

We only need to consider the first order neighbour

# Cluster based analysis (Social distance)

```{r}
tm_shape(obesity_data) + tm_dots(fill = "CLUSTER", size = 0.5)
(cluster_nb = read.gal("clusters.gal"))
plot(cluster_nb, st_geometry(obesity_data))

#Spatial autocorrelation measures.
cluster_wlist = nb2listw(cluster_nb)
moran.test(obesity_data_sf_2023_OSO$PREVALENCE, listw = cluster_wlist, na.action = na.omit)
obesity_data_sf_2023_OSO %>% summary()
```

# Income distribution (Lucas)

```{r}
census <- read.csv("census stats.csv") %>% 
  mutate(PLN_AREA_N = toupper(PLN_AREA_N))
combine_data <- left_join(ura_planning_areas, census)
combine_data
summary(census)
areas <- c(
"ANG MO KIO", "BEDOK", "BISHAN", "BUKIT BATOK", "BUKIT MERAH", "BUKIT PANJANG",
"BUKIT TIMAH", "CHOA CHU KANG", "CLEMENTI", "DOWNTOWN CORE", "GEYLANG", "HOUGANG",
"JURONG EAST", "JURONG WEST", "KALLANG", "MARINE PARADE", "OUTRAM", "NOVENA", "PASIR RIS", "PUNGGOL",   "QUEENSTOWN", "RIVER VALLEY", "SEMBAWANG", "SENGKANG", "SERANGOON", "TAMPINES",
"TANGLIN", "TOA PAYOH", "WOODLANDS", "YISHUN"
)
for (area in areas) {
area_var <- gsub(" ", "_", tolower(area))
assign(paste0(area_var, "_set"), subset(combine_data, PLN_AREA_N == area))
assign(area_var, st_union(get(paste0(area_var, "_set"))))
assign(paste0(area_var, "_point"), st_centroid(get(area_var)))
}
st_coordinates(ang_mo_kio_point)
st_coordinates(bedok_point)
st_coordinates(bishan_point)
st_coordinates(bukit_batok_point)
st_coordinates(bukit_merah_point)
st_coordinates(bukit_panjang_point)
st_coordinates(bukit_timah_point)
st_coordinates(choa_chu_kang_point)
st_coordinates(clementi_point)
st_coordinates(downtown_core_point)
st_coordinates(geylang_point)
st_coordinates(hougang_point)
st_coordinates(jurong_east_point)
st_coordinates(jurong_west_point)
st_coordinates(kallang_point)
st_coordinates(marine_parade_point)
st_coordinates(outram_point)
st_coordinates(novena_point)
st_coordinates(pasir_ris_point)
st_coordinates(punggol_point)
st_coordinates(queenstown_point)
st_coordinates(river_valley_point)
st_coordinates(sembawang_point)
st_coordinates(sengkang_point)
st_coordinates(serangoon_point)
st_coordinates(tampines_point)
st_coordinates(tanglin_point)
st_coordinates(toa_payoh_point)
st_coordinates(woodlands_point)
st_coordinates(yishun_point)
points_df = data.frame(PLN_AREA_N = c("ANG MO KIO", "BEDOK", "BISHAN", "BUKIT BATOK", "BUKIT MERAH", "BUKIT PANJANG",
"BUKIT TIMAH", "CHOA CHU KANG", "CLEMENTI", "DOWNTOWN CORE", "GEYLANG", "HOUGANG",
"JURONG EAST", "JURONG WEST", "KALLANG", "MARINE PARADE", "OUTRAM", "NOVENA", "PASIR RIS", "PUNGGOL",   "QUEENSTOWN", "RIVER VALLEY", "SEMBAWANG", "SENGKANG", "SERANGOON", "TAMPINES",
"TANGLIN", "TOA PAYOH", "WOODLANDS", "YISHUN"),
lat=c(40229.12,34032.1,37450.89,37527.65,28662.87,38761.84,34689,40833.42,33319.17,29721.45,33683.82,38409.7,33633.69,35974.53,32515.77,31398.33,29477.49,34356.64,40066.41,43023.56,30164.7,31156.94,48594.64,41466.18,38582.59,36200.47,32298.93,35429.21,46928.63,44086.22),
long = c(28976.88,38582.67,28789.76,19255.42,26865.78,21287.04,23256.76,18415.05,19923.36,30335.19,34255.04,34285.76,17035.36,13708.69,31685.37,35005.86,28972.96,28221.51,40795.84,36538.42,22573.46,28072.91,26387.4,34051.82,31839.38,41459.48,26250.09,31083.53,22923.8,28404.04))
points_df
points_sf <- st_as_sf(points_df, coords = c("long", "lat"), crs = sg_crs)
points_sf
census_merge = left_join(points_sf,census)
ura_planning_areas_map+tm_shape(census_merge)+ tm_symbols(size=0.5,fill="Income")
ura_planning_areas_map+tm_shape(census_merge)+ tm_symbols(size=0.5,fill="Education")

tm_shape(combine_data) + 
  tm_fill(fill="Income", 
          fill.scale = tm_scale(breaks = c(6925,8396,9532,11317,16197))
          ) +
  tm_title("Breakdown by Household Income")
tm_shape(combine_data) + 
  tm_fill(fill="Education", 
          fill.scale = tm_scale(breaks = c(9.76,10.74,11.25,11.89,14.78))
          ) +
  tm_title("Breakdown by Education Level")
tm_shape(combine_data) + 
  tm_fill(fill="Primary", 
          fill.scale = tm_scale(breaks = c(61,4778,7043,11681,21822))
          ) +
  tm_title("Breakdown by Pri Students")
tm_shape(combine_data) + 
  tm_fill(fill="Secondary", 
          fill.scale = tm_scale(breaks=c(59,3526,4894,8804,13221))
          ) +
  tm_title("Breakdown by Sec Students")
```

# Spatial Descriptive Summary Measures of Income (Lucas)

```{r}
census_coords <- st_coordinates(census_merge)
income_mean <- calc_mnc(id = 1, points = census_coords, weighted = T, weights = census_merge$Income)
income_median <- calc_mdc(id = 2, points = census_coords)
income_mean_median <- rbind(income_mean$LOCATIONS, income_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
income_mean_median$id = c("Weighted mean", "Weighted median")

income_sdd <- calc_sdd(id = 3, points = census_coords)
income_sdd_line <- income_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_sde <- calc_sde(id = 4, points = census_coords)
income_sde_line <- income_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = census_merge$Income,
  points = census_coords)
income_sde_weighted_line <- income_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

income_map <- ura_planning_area_map +
    tm_shape(census_merge, name = "Income") +
    tm_symbols(
        size = "Income",
        size.scale = tm_scale_continuous(values.scale = 0.8),
        size.legend = tm_legend_hide(),
        fill = "Income", 
        # a green-red diverging scale to indicate severity of overweight prevalence
        fill.scale = tm_scale_continuous(values = "-brewer.rd_yl_gn"), 
        fill.legend = tm_legend(
            title = "Income Distribution",
            orientation = "landscape", 
            position = c("BOTTOM", "LEFT"),
            item.height = 0.5, item.width = 2.1
        )
    ) + 
    tm_shape(income_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
    tm_shape(income_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
    tm_shape(income_sde_weighted_line, name = "weighted SDE") + 
    tm_lines(col = "red", lwd = 2, lty = 3) +
    tm_shape(income_mean_median, name = "Summary measures") + tm_dots(
        size = 0.5, shape = "id", fill = "white", 
        shape.legend = tm_legend("Summary measures")
    ) + 
    tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
    tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
    tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
    tm_title("Income Distribution across SG Planning Areas")

print(income_map)
```

# Spatial Descriptive Summary Measures of Education Years (Lucas)

```{r}
education_mean <- calc_mnc(id = 1, points = census_coords, weighted = T, weights = census_merge$Education)
education_median <- calc_mdc(id = 2, points = census_coords)
education_mean_median <- rbind(education_mean$LOCATIONS, education_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
education_mean_median$id = c("Weighted mean", "Weighted median")

education_sdd <- calc_sdd(id = 3, points = census_coords)
education_sdd_line <- education_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_sde <- calc_sde(id = 4, points = census_coords)
education_sde_line <- education_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = census_merge$Education,
  points = census_coords)
education_sde_weighted_line <- education_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

education_map <- ura_planning_area_map +
    tm_shape(census_merge, name = "Education") +
    tm_symbols(
        size = "Education",
        size.scale = tm_scale_continuous(values.scale = 0.8),
        size.legend = tm_legend_hide(),
        fill = "Education", 
        # a green-red diverging scale to indicate severity of overweight prevalence
        fill.scale = tm_scale_continuous(values = "-brewer.rd_yl_gn"), 
        fill.legend = tm_legend(
            title = "Education Years",
            orientation = "landscape", 
            position = c("BOTTOM", "LEFT"),
            item.height = 0.5, item.width = 2.1
        )
    ) + 
    tm_shape(education_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
    tm_shape(education_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
    tm_shape(education_sde_weighted_line, name = "weighted SDE") + 
    tm_lines(col = "red", lwd = 2, lty = 3) +
    tm_shape(education_mean_median, name = "Summary measures") + tm_dots(
        size = 0.5, shape = "id", fill = "white", 
        shape.legend = tm_legend("Summary measures")
    ) + 
    tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
    tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
    tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
    tm_title("Education Years Across SG Planning Areas")

print(education_map)
```

# Food and Nutrition (Nina)

```{r}
#Hawker centre data
hawker_full = st_read("NEAMarketandFoodCentre.geojson") %>%
  st_transform(crs = sg_crs)

hawker = hawker_full["geometry"]


#Fast Food Outlets (Mcdonald's and 711)
macs_full = st_read("mcdonalds_singapore.geojson") %>%
  st_transform(crs = sg_crs)

  #Check validity
table(st_is_valid(macs_full))

  #Check CRS
st_crs(macs_full)$epsg

  #Extract necessary columns for analysis
macs = macs_full[,"geometry"]

  #7-11 Outlets
seven_eleven_full = st_read("711_singapore.geojson") %>%
  st_transform(crs = sg_crs)


  #Extract necessary columns for analysis
seven_eleven = seven_eleven_full[,"geometry"]
  
  #Check validity
table(st_is_valid(seven_eleven))

  #Check CRS
st_crs(seven_eleven)$epsg

  #Plot of 711 outlets
tm_shape(sg_ura_boundaries) + 
  tm_borders() +
  tm_shape(seven_eleven) + 
  tm_dots(col = "green", size = 0.3)

#Combine data into single SF object
seven_eleven_sf = mutate(seven_eleven, outlet = "7-11")
macs_sf = mutate(macs, outlet = "mcdonalds")
hawker_sf = mutate(hawker, outlet = "hawker")
food = rbind(seven_eleven_sf, macs_sf, hawker_sf)


#Primary school analysis

#duplicate primary school data
obesity_pri_food = obesity_pri_sch

#check units
st_crs(obesity_pri_food)$units
pri_schools_buffer1 <- st_buffer(obesity_pri_food, dist = 1000) %>% st_geometry()
pri_intersections <- st_intersects(pri_schools_buffer1, food)

#calculate the number of food outlets within a 1km radius of each school
obesity_pri_food$num_food_outlets <- lengths(pri_intersections)
obesity_pri_food

#show density via choropleth map
ura_regions_map + 
  tm_shape(obesity_pri_food) +
  tm_fill(col = "num_food_outlets", 
          palette = "brewer.yl_or_rd",
          alpha = 0.7) + 
  tm_borders(lwd = 0.5) +
  tm_title("Food Outlet Density by Primary School")


#Secondary school analysis

#duplicate primary school data
obesity_sec_food = obesity_sec_sch

#check units
st_crs(obesity_sec_food)$units
sec_schools_buffer1 <- st_buffer(obesity_sec_food, dist = 1000) %>% st_geometry()
sec_intersections <- st_intersects(sec_schools_buffer1, food)

#calculate the number of food outlets within a 1km radius of each school
obesity_sec_food$num_food_outlets <- lengths(sec_intersections)
obesity_sec_food

#show density via choropleth map
ura_regions_map + 
  tm_shape(obesity_sec_food) +
  tm_fill(col = "num_food_outlets", 
          palette = "brewer.yl_or_rd",
          alpha = 0.7) + 
  tm_borders(lwd = 0.5) +
  tm_title("Food Outlet Density by Secondary School")
```

# Physical activity (Qasim)

```{r}
# Loading school co-curricular activities data
school_sports_ccas <- 
  read.csv("CocurricularactivitiesCCAs.csv") %>% 
  group_by(school_name) %>% 
  summarise(
    total = n(),
    physical_sports_count = sum(cca_grouping_desc == "PHYSICAL SPORTS")) %>% 
    select(school_name, physical_sports_count)


#2023 OSO school obesity data combined with 2024-25 school physical activity cca data
#gives spatial awareness to physical activity cca by joining to obesity data set by school name
obesity_joined_school_sports_data <- 
  obesity_data_sf_2023_OSO %>% 
  left_join(school_sports_ccas, by = join_by(SCHOOL == school_name)) %>%
  mutate(sports_cca_per_100 = physical_sports_count / ENROLMENT * 100, #ratio of sports cca per 100 students
         LEVEL = case_when(
           LEVEL == "PRIMARY + SECONDARY" & PRI == 1 ~ "PRIMARY",
           LEVEL == "PRIMARY + SECONDARY" & PRI == 0 ~ "SECONDARY",
           TRUE ~ LEVEL
         )
        ) 



#Visualising physical sports participation by school level

###########################PRIMARY SCHOOL####################################

# Primary school sports participation

#NEED TO AVERAGE VALUES FOR MISSING VALUES
pri_cca_data <- obesity_joined_school_sports_data %>% filter(LEVEL == "PRIMARY", !is.na(sports_cca_per_100))

pri_cca_map <- ura_subzones_map +  
  tm_shape(pri_cca_data) +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    shape = 21,  # circle
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"),
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
    )
  ) + 
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Ratio of Sports CCAs per 100 Students by Primary School"
  )

pri_cca_map 

pri_cca_data %>% summary()

# Spatial descriptive summary measures of physical sports participation by primary school

# Mean centre, standard deviation distance, standard deviation ellipse
pri_cca_mean <- calc_mnc(id = 1, points = st_coordinates(pri_cca_data))
pri_cca_median <- calc_mdc(id = 2, points = st_coordinates(pri_cca_data))
pri_cca_mean_median <- rbind(pri_cca_mean$LOCATIONS, pri_cca_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
pri_cca_mean_median$id = c("Spatial mean", "Spatial median")

pri_cca_sdd <- calc_sdd(id = 3, points = st_coordinates(pri_cca_data))
pri_cca_sdd_line <- pri_cca_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_sde <- calc_sde(id = 4, points = st_coordinates(pri_cca_data))
pri_cca_sde_line <- pri_cca_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = pri_cca_data$sports_cca_per_100,
  points = st_coordinates(pri_cca_data))
pri_cca_sde_weighted_line <- pri_cca_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

pri_cca_map_sde <- ura_subzones_map +
  tm_shape(pri_cca_data, name = "Ratio of Sports CCAs per 100 Students by School") +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(pri_cca_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(pri_cca_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(pri_cca_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(pri_cca_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Ratio of Sports CCAs per 100 Students by Primary School")

pri_cca_map_sde


####################################SECONDARY SCHOOL####################################

sec_cca_data <- obesity_joined_school_sports_data %>% filter(LEVEL == "SECONDARY", !is.na(sports_cca_per_100))

sec_cca_map <- ura_subzones_map +  
  tm_shape(sec_cca_data) +
  tm_symbols(
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    shape = 22,  #square
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"),
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
    )
  ) + 
  tm_layout(
    legend.position = c("BOTTOM", "RIGHT"),
    legend.title.size = 1.2,
    main.title = "Ratio of Sports CCAs per 100 Students by Secondary School"
  )


sec_cca_map

sec_cca_data %>% summary()
# Spatial descriptive summary measures of physical sports participation by primary school

# Mean centre, standard deviation distance, standard deviation ellipse
sec_cca_mean <- calc_mnc(id = 1, points = st_coordinates(sec_cca_data))
sec_cca_median <- calc_mdc(id = 2, points = st_coordinates(sec_cca_data))
sec_cca_mean_median <- rbind(sec_cca_mean$LOCATIONS, sec_cca_median$LOCATIONS) %>% 
  data.frame() %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs)
sec_cca_mean_median$id = c("Spatial mean", "Spatial median")

sec_cca_sdd <- calc_sdd(id = 3, points = st_coordinates(sec_cca_data))
sec_cca_sdd_line <- sec_cca_sdd$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_sde <- calc_sde(id = 4, points = st_coordinates(sec_cca_data))
sec_cca_sde_line <- sec_cca_sde$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_sde_weighted <- calc_sde(
  id = 5, calccentre = T, weighted = T, weights = sec_cca_data$sports_cca_per_100,
  points = st_coordinates(sec_cca_data))
sec_cca_sde_weighted_line <- sec_cca_sde_weighted$LOCATIONS %>% 
  st_as_sf(coords = c("x", "y"), crs = sg_crs) %>% 
  st_combine() %>% 
  st_cast("LINESTRING")

sec_cca_map_sde <- ura_subzones_map +
  tm_shape(sec_cca_data, name = "Ratio of Sports CCAs per 100 Students by School") +
  tm_symbols(
    shape = 22,
    size = "sports_cca_per_100",
    size.scale = tm_scale_continuous(values.scale = 0.8),
    size.legend = tm_legend_hide(),
    fill = "sports_cca_per_100", 
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) + 
  tm_shape(sec_cca_sdd_line, name = "SDD") + tm_lines(lwd = 2, lty = 1) + 
  tm_shape(sec_cca_sde_line, name = "SDE") + tm_lines(lwd = 2, lty = 3) +
  tm_shape(sec_cca_sde_weighted_line, name = "weighted SDE") + 
  tm_lines(col = "red", lwd = 2, lty = 3) +
  tm_shape(sec_cca_mean_median, name = "Summary measures") + tm_dots(
    size = 0.5, shape = "id", fill = "white", 
    shape.legend = tm_legend("Summary measures")
    ) + 
  tm_add_legend(type = "lines", labels = "SDD", lty = 1) +
  tm_add_legend(type = "lines", labels = "SDE", lty = 3) +
  tm_add_legend(type = "lines", labels = "weighted SDE", lty = 3, col = "red") +
  tm_title("Ratio of Sports CCAs per 100 Students by Secondary School")

sec_cca_map_sde


###################################################################


# Aggregating sports cca ratio counts by URA subzones
sports_ura_subzones <- st_join(ura_subzones, obesity_joined_school_sports_data) %>% 
  group_by(SUBZONE_N) %>% 
  summarise(
    RATIO_AGG = mean(sports_cca_per_100, na.rm = T),
    geometry = st_union(geometry)
    )

cca_subzone_map <- ura_subzones_map + sports_ura_subzones %>% 
  tm_shape(name = "Sports CCA Ratio per 100") +
  tm_polygons(
    fill = "RATIO_AGG",
    fill.scale = tm_scale_continuous(values = "brewer.rd_yl_gn"), 
    fill.legend = tm_legend(
      title = "Sports CCAs per 100 Students",
      orientation = "landscape", 
      position = c("BOTTOM", "LEFT"),
      item.height = 0.5, item.width = 2.1
      )
    ) +
  tm_title("Sports CCA Ratio by URA subzones")

print(cca_subzone_map)





#bivariate chloropleth for obesity prevalence and physical sports participation?


library(classInt);library(dplyr)

# 1️⃣ Select the two variables for the bivariate map
obesity_sports_data <- obesity_joined_school_sports_data %>% 
  filter(!is.na(sports_cca_per_100), !is.na(PREVALENCE)) %>%
  select(geometry, sports_cca_per_100, PREVALENCE)

# 2️⃣ Classify both variables into 3 categories (low, medium, high)
obesity_sports_data <- obesity_sports_data %>%
  mutate(
    sports_cat = cut(sports_cca_per_100, 
                     breaks = classIntervals(sports_cca_per_100, 3, style = "quantile")$brks, 
                     labels = c("Low", "Medium", "High"), 
                     include.lowest = TRUE),
    obesity_cat = cut(PREVALENCE, 
                      breaks = classIntervals(PREVALENCE, 3, style = "quantile")$brks, 
                      labels = c("Low", "Medium", "High"), 
                      include.lowest = TRUE)
  )

# 3️⃣ Combine the two classifications into one
obesity_sports_data <- obesity_sports_data %>%
  mutate(bivariate_class = paste(sports_cat, obesity_cat, sep = "_"))

# 4️⃣ Define a bivariate color scheme (3x3 grid)
bivariate_colors <- c(
  "Low_Low" = "#e8e8e8", "Medium_Low" = "#b4d3e4", "High_Low" = "#8bb5d1",
  "Low_Medium" = "#e4b4b4", "Medium_Medium" = "#b4b4b4", "High_Medium" = "#8b8b8b",
  "Low_High" = "#d18b8b", "Medium_High" = "#b58b8b", "High_High" = "#8b8b8b"
)

# 5️⃣ Create the bivariate choropleth map
bivariate_map <-ura_subzones_map +
  tm_shape(obesity_sports_data) +
  tm_polygons(fill = "bivariate_class", palette = bivariate_colors, title = "Bivariate Categories") +
  tm_layout(legend.position = c("right", "bottom"))

# 6️⃣ Print the map
bivariate_map


```

# Other Useful stuff

```{r}
tmap_mode("view") #interactive map
tmap_mode("plot") #static map
# tmap_save(tmap_object, 'xx.jpg') # for saving maps as images
cols4all::c4a_gui() # colour scales
RColorBrewer::display.brewer.all()
```
